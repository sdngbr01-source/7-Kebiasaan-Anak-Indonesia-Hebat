<!DOCTYPE html>
<html>
<head>
    <title>Backup System - 7 Kebiasaan Anak</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .container {
            background: #f5f5f5;
            padding: 30px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .btn {
            background: #4b6cb7;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .btn:hover {
            background: #182848;
        }
        .data-box {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š Backup & Restore System</h1>
    
    <div class="container">
        <h2>ğŸ” GitHub Backup System</h2>
        
        <!-- STEP 1: Get GitHub Token -->
        <div class="data-box">
            <h3>Step 1: Dapatkan GitHub Token</h3>
            <p>1. Login ke <a href="https://github.com" target="_blank">GitHub</a></p>
            <p>2. Settings â†’ Developer settings â†’ Personal access tokens</p>
            <p>3. Generate new token (beri nama: "7Kebiasaan Backup")</p>
            <p>4. Cek "repo" (full control of repositories)</p>
            <p>5. Copy token (simpan rahasia!)</p>
        </div>
        
        <!-- STEP 2: Config -->
        <div class="data-box">
            <h3>Step 2: Konfigurasi</h3>
            <input type="text" id="githubToken" placeholder="GitHub Token" style="width: 300px; padding: 8px; margin: 5px;">
            <input type="text" id="repoName" placeholder="nama-repo" value="7kebiasaan-data" style="width: 200px; padding: 8px; margin: 5px;">
            <p><small>Repo akan dibuat otomatis jika belum ada</small></p>
        </div>
        
        <!-- STEP 3: Backup Data -->
        <div class="data-box">
            <h3>Step 3: Backup Data Sekarang</h3>
            <button class="btn" onclick="backupToGitHub()">ğŸ’¾ Backup ke GitHub</button>
            <button class="btn" onclick="restoreFromGitHub()">ğŸ“¥ Restore dari GitHub</button>
        </div>
        
        <!-- Local Backup -->
        <div class="data-box">
            <h3>ğŸ”„ Backup Lokal</h3>
            <button class="btn" onclick="downloadLocalBackup()">â¬‡ï¸ Download Backup</button>
            <button class="btn" onclick="uploadLocalBackup()">â¬†ï¸ Upload Backup</button>
            <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="handleFileUpload(this.files[0])">
        </div>
        
        <!-- Data Preview -->
        <div class="data-box">
            <h3>ğŸ“ˆ Data Saat Ini:</h3>
            <p>Users: <span id="userCount">0</span> terdaftar</p>
            <p>Habits Data: <span id="habitCount">0</span> records</p>
            <button class="btn" onclick="viewData()">ğŸ‘ï¸ Lihat Data</button>
        </div>
        
        <div id="result" style="margin-top: 20px; padding: 10px; background: #e8f5e9; border-radius: 5px; display: none;"></div>
        <pre id="dataView" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; max-height: 300px;"></pre>
    </div>
    
    <script>
        // Update counts
        function updateCounts() {
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const habits = JSON.parse(localStorage.getItem('habitsData') || '[]');
            document.getElementById('userCount').textContent = users.length;
            document.getElementById('habitCount').textContent = habits.length;
        }
        
        // Download backup lokal
        function downloadLocalBackup() {
            const backup = {
                registeredUsers: JSON.parse(localStorage.getItem('registeredUsers') || '[]'),
                habitsData: JSON.parse(localStorage.getItem('habitsData') || '[]'),
                backupDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `7kebiasaan-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showResult('âœ… Backup berhasil didownload!');
        }
        
        // Upload backup lokal
        function uploadLocalBackup() {
            document.getElementById('backupFile').click();
        }
        
        function handleFileUpload(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (backup.registeredUsers && backup.habitsData) {
                        localStorage.setItem('registeredUsers', JSON.stringify(backup.registeredUsers));
                        localStorage.setItem('habitsData', JSON.stringify(backup.habitsData));
                        updateCounts();
                        showResult(`âœ… Data berhasil direstore! (${backup.registeredUsers.length} users, ${backup.habitsData.length} habits)`);
                    } else {
                        showResult('âŒ Format backup tidak valid', true);
                    }
                } catch (error) {
                    showResult('âŒ Error membaca file: ' + error.message, true);
                }
            };
            reader.readAsText(file);
        }
        
        // Backup ke GitHub
        async function backupToGitHub() {
            const token = document.getElementById('githubToken').value;
            const repo = document.getElementById('repoName').value;
            
            if (!token) {
                showResult('âŒ GitHub Token diperlukan!', true);
                return;
            }
            
            const backup = {
                registeredUsers: JSON.parse(localStorage.getItem('registeredUsers') || '[]'),
                habitsData: JSON.parse(localStorage.getItem('habitsData') || '[]'),
                backupDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const content = JSON.stringify(backup, null, 2);
            const contentBase64 = btoa(unescape(encodeURIComponent(content)));
            
            try {
                // Cek apakah repo sudah ada
                let sha;
                try {
                    const response = await fetch(`https://api.github.com/repos/${repo}/contents/backup.json`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha;
                    }
                } catch (e) {
                    // File belum ada
                }
                
                // Buat/update file di GitHub
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/backup.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Backup data ${new Date().toLocaleString()}`,
                        content: contentBase64,
                        sha: sha
                    })
                });
                
                if (response.ok) {
                    showResult('âœ… Backup berhasil disimpan ke GitHub!');
                } else {
                    showResult('âŒ Gagal menyimpan ke GitHub', true);
                }
            } catch (error) {
                showResult('âŒ Error: ' + error.message, true);
            }
        }
        
        // Restore dari GitHub
        async function restoreFromGitHub() {
            const token = document.getElementById('githubToken').value;
            const repo = document.getElementById('repoName').value;
            
            if (!token) {
                showResult('âŒ GitHub Token diperlukan!', true);
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/backup.json`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    const backup = JSON.parse(content);
                    
                    if (backup.registeredUsers && backup.habitsData) {
                        localStorage.setItem('registeredUsers', JSON.stringify(backup.registeredUsers));
                        localStorage.setItem('habitsData', JSON.stringify(backup.habitsData));
                        updateCounts();
                        showResult(`âœ… Data berhasil direstore dari GitHub! (${backup.backupDate})`);
                    } else {
                        showResult('âŒ Format backup tidak valid', true);
                    }
                } else {
                    showResult('âŒ Tidak ada backup di GitHub', true);
                }
            } catch (error) {
                showResult('âŒ Error: ' + error.message, true);
            }
        }
        
        // View data
        function viewData() {
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const habits = JSON.parse(localStorage.getItem('habitsData') || '[]');
            
            const data = {
                users: users,
                habits: habits.slice(0, 5), // Show first 5 habits only
                totalHabits: habits.length,
                lastBackup: localStorage.getItem('lastBackup') || 'Belum ada backup'
            };
            
            document.getElementById('dataView').textContent = JSON.stringify(data, null, 2);
            document.getElementById('dataView').style.display = 'block';
        }
        
        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.style.background = isError ? '#f8d7da' : '#d4edda';
            resultDiv.style.color = isError ? '#721c24' : '#155724';
            resultDiv.style.display = 'block';
            
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCounts();
            
            // Auto-load GitHub token from localStorage if exists
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
            }
            
            // Save token when changed
            document.getElementById('githubToken').addEventListener('change', function() {
                localStorage.setItem('githubToken', this.value);
            });
        });
    </script>
</body>
</html>

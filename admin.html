<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - 7 Kebiasaan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    <style>
        /* Additional Admin Styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-badge.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-badge.updated {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .import-box {
            border: 2px dashed #ccc;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            background: #f9f9f9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            margin: 10px 0;
            color: #2196F3;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .action-btn {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
            transform: translateY(-2px);
        }
        
        .import-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .progress-bar-small {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .progress-fill-small {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .completion-excellent { background: #4CAF50; }
        .completion-good { background: #FF9800; }
        .completion-poor { background: #2196F3; }
        .completion-none { background: #f44336; }
        
        @media (max-width: 768px) {
            .import-actions {
                grid-template-columns: 1fr;
            }
        }
        
        /* Fix for role display */
        .role-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .role-badge.admin {
            background: #dc3545;
            color: white;
        }
        
        .role-badge.user {
            background: #28a745;
            color: white;
        }
        
        /* Additional styles for reporting */
        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .report-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .report-summary h4 {
            margin-top: 0;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
            <div class="nav-links">
                <button onclick="debugClasses()" style="margin-right: 10px; padding: 8px 15px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-bug"></i> Debug
                </button>
                <button onclick="refreshClasses()" style="margin-right: 10px; padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-sync-alt"></i> Refresh Classes
                </button>
                <span id="adminName">Loading...</span>
                <button onclick="logout()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-menu">
                <a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#users"><i class="fas fa-users"></i> Kelola Pengguna</a>
                <a href="#addUser"><i class="fas fa-user-plus"></i> Tambah Pengguna</a>
                <a href="#importExcel"><i class="fas fa-file-import"></i> Import dari Excel</a>
                <a href="#progress"><i class="fas fa-chart-line"></i> Progress Tracking</a>
                <a href="#reporting"><i class="fas fa-file-alt"></i> Reporting</a>
                <a href="#stats"><i class="fas fa-chart-bar"></i> Statistik</a>
                <a href="#system"><i class="fas fa-cog"></i> System Info</a>
            </div>
        </aside>

        <main class="admin-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="admin-section">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Admin</h2>
                
                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="admin-stat-card">
                        <h3 id="totalUsersAdmin">0</h3>
                        <p>Total Pengguna</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="adminUsers">0</h3>
                        <p>Admin</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="regularUsers">0</h3>
                        <p>Pengguna Biasa</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="totalHabits">0</h3>
                        <p>Data Kebiasaan</p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#addUser\\']').click()">
                        <i class="fas fa-user-plus fa-2x"></i>
                        <p>Tambah User</p>
                    </div>
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#importExcel\\']').click()">
                        <i class="fas fa-file-import fa-2x"></i>
                        <p>Import Excel</p>
                    </div>
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#progress\\']').click()">
                        <i class="fas fa-chart-line fa-2x"></i>
                        <p>Progress User</p>
                    </div>
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#reporting\\']').click()">
                        <i class="fas fa-file-alt fa-2x"></i>
                        <p>Laporan</p>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div style="margin-top: 40px;">
                    <h3><i class="fas fa-history"></i> Aktivitas Terbaru</h3>
                    <div id="recentActivity" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 100px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat aktivitas...
                        </div>
                    </div>
                </div>
            </section>

            <!-- Manage Users Section -->
            <section id="users" class="admin-section" style="display: none;">
                <h2><i class="fas fa-users"></i> Kelola Pengguna</h2>
                
                <!-- Search and Filter -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="searchUser" placeholder="Cari nama pengguna..." 
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <select id="filterRole" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Semua Role</option>
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                    <select id="filterKelas" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Semua Kelas</option>
                        <!-- Kelas akan diisi secara dinamis -->
                    </select>
                    <button onclick="searchUsers()" class="btn-primary">
                        <i class="fas fa-search"></i> Cari
                    </button>
                    <button onclick="resetSearch()" class="btn-logout">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
                
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Role</th>
                                <th>Tanggal Daftar</th>
                                <th>Progress</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px;">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data pengguna...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <div>
                        Menampilkan <span id="currentCount">0</span> dari <span id="totalCount">0</span> pengguna
                    </div>
                    <div>
                        <button onclick="previousPage()" id="prevBtn" disabled class="btn-primary">
                            <i class="fas fa-chevron-left"></i> Sebelumnya
                        </button>
                        <span style="margin: 0 10px;">Halaman <span id="currentPage">1</span></span>
                        <button onclick="nextPage()" id="nextBtn" disabled class="btn-primary">
                            Selanjutnya <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Add User Section -->
            <section id="addUser" class="admin-section" style="display: none;">
                <h2><i class="fas fa-user-plus"></i> Tambah Pengguna Baru</h2>
                
                <div class="add-user-form">
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newUserName"><i class="fas fa-user"></i> Nama Pengguna</label>
                            <input type="text" id="newUserName" placeholder="Masukkan nama lengkap" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="userRole"><i class="fas fa-user-tag"></i> Role</label>
                            <select id="userRole" required onchange="toggleKelasField()">
                                <option value="user">User (Bisa login dengan nama saja)</option>
                                <option value="admin">Admin (Butuh password)</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="kelasField">
                            <label for="userKelas"><i class="fas fa-graduation-cap"></i> Kelas</label>
                            <select id="userKelas" required>
                                <option value="">Pilih Kelas</option>
                                <!-- Kelas akan diisi secara dinamis -->
                            </select>
                        </div>
                        
                        <div class="form-group" id="passwordField" style="display: none;">
                            <label for="userPassword"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="userPassword" placeholder="Masukkan password untuk admin">
                            <small style="color: #666;">Password hanya diperlukan untuk admin</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="userEmail"><i class="fas fa-envelope"></i> Email (Opsional)</label>
                            <input type="email" id="userEmail" placeholder="email@contoh.com">
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn-primary" style="flex: 1;">
                                <i class="fas fa-plus"></i> Tambah Pengguna
                            </button>
                            <button type="button" onclick="document.getElementById('addUserForm').reset(); toggleKelasField();" 
                                    class="btn-logout" style="flex: 1;">
                                <i class="fas fa-redo"></i> Reset Form
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Bulk Add -->
                <div style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px;">
                    <h3><i class="fas fa-users"></i> Tambah Banyak User Sekaligus</h3>
                    <p style="color: #666;">Format: Nama,Kelas,Role,Password(opsional),Email(opsional)</p>
                    <textarea id="bulkUsers" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0;" 
                              placeholder="Contoh:
FAJAR ABIYAN HIDAYAT,Kelas 6A,user,,fajar@email.com
SITI AMINAH,Kelas 5B,user,,siti@email.com
ADMIN UTAMA,-,admin,admin123,admin@email.com"></textarea>
                    <button onclick="addBulkUsers()" class="btn-admin" style="margin-top: 10px;">
                        <i class="fas fa-user-plus"></i> Tambah Semua User
                    </button>
                </div>
            </section>

            <!-- Import Excel Section -->
            <section id="importExcel" class="admin-section" style="display: none;">
                <h2><i class="fas fa-file-import"></i> Import Data dari Excel/CSV</h2>
                
                <!-- Instructions -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-info-circle"></i> Petunjuk Import</h4>
                    <ol style="margin: 10px 0 10px 20px;">
                        <li>Download template Excel/CSV terlebih dahulu</li>
                        <li>Isi data user di Excel sesuai format kolom</li>
                        <li>Upload file Excel/CSV yang sudah diisi</li>
                        <li>Preview data sebelum import ke database</li>
                        <li>Konfirmasi import untuk menyimpan ke database</li>
                    </ol>
                    <p><strong>Format File:</strong> CSV dengan kolom: Nama, Kelas, Role, Password (opsional), Email (opsional)</p>
                    <p><strong>Catatan:</strong> Untuk admin, kelas bisa dikosongkan atau diisi "-"</p>
                </div>
                
                <!-- Import Actions -->
                <div class="import-actions">
                    <!-- Download Template -->
                    <div style="text-align: center;">
                        <div class="import-box">
                            <i class="fas fa-file-excel" style="font-size: 4rem; color: #4CAF50; margin-bottom: 15px;"></i>
                            <h4>Download Template</h4>
                            <p>Template dengan format yang benar</p>
                        </div>
                        <button onclick="downloadExcelTemplate()" class="btn-primary" style="width: 100%; padding: 15px;">
                            <i class="fas fa-download"></i> Download Template CSV
                        </button>
                    </div>
                    
                    <!-- Upload File -->
                    <div style="text-align: center;">
                        <div class="import-box" id="dropZone" 
                             ondrop="dropHandler(event)" 
                             ondragover="dragOverHandler(event)"
                             style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: #2196F3; margin-bottom: 15px;"></i>
                            <h4>Upload File</h4>
                            <p>Drag & drop file Excel/CSV di sini</p>
                            <p style="font-size: 0.9rem; color: #666;">atau</p>
                            <input type="file" id="excelFile" accept=".csv,.xlsx,.xls" style="margin-top: 10px;">
                        </div>
                        <button onclick="uploadExcelFile()" class="btn-admin" style="width: 100%; padding: 15px;">
                            <i class="fas fa-upload"></i> Upload & Preview Data
                        </button>
                    </div>
                </div>
                
                <!-- Preview Table -->
                <div id="excelPreview" style="display: none; margin-top: 40px;">
                    <h4><i class="fas fa-eye"></i> Preview Data (Akan Diimport)</h4>
                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama</th>
                                    <th>Kelas</th>
                                    <th>Role</th>
                                    <th>Password</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="excelDataPreview">
                                <!-- Data preview akan muncul di sini -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="confirmImport()" class="btn-primary" style="padding: 15px 40px; font-size: 1.1rem;">
                            <i class="fas fa-database"></i> KONFIRMASI IMPORT KE DATABASE
                        </button>
                        <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                            <i class="fas fa-exclamation-triangle"></i> Pastikan data sudah benar sebelum import
                        </p>
                    </div>
                </div>
                
                <!-- Import Status -->
                <div id="importStatus" style="margin-top: 30px;"></div>
            </section>

            <!-- Progress Tracking Section -->
            <section id="progress" class="admin-section" style="display: none;">
                <h2><i class="fas fa-chart-line"></i> Progress Tracking</h2>
                
                <!-- Filters -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-filter"></i> Filter Data</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <label for="progressKelas">Kelas</label>
                            <select id="progressKelas" style="width: 100%; padding: 10px;">
                                <option value="all">Semua Kelas</option>
                                <!-- Classes will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="progressSort">Urutkan</label>
                            <select id="progressSort" style="width: 100%; padding: 10px;">
                                <option value="name">Nama A-Z</option>
                                <option value="name_desc">Nama Z-A</option>
                                <option value="score">Skor Tertinggi</option>
                                <option value="days">Hari Terbanyak</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="loadProgressData()" class="btn-primary">
                            <i class="fas fa-search"></i> Terapkan Filter
                        </button>
                        <button onclick="resetProgressFilters()" class="btn-logout">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <button onclick="exportProgressToExcel()" class="btn-admin" style="margin-left: auto;">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Class Statistics -->
                <div id="classStats" style="display: none; margin-bottom: 30px;">
                    <h4><i class="fas fa-chart-bar"></i> Statistik Kelas</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users fa-2x"></i>
                            <h3 id="classTotalStudents">0</h3>
                            <p>Total Siswa</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-star fa-2x"></i>
                            <h3 id="classAverageScore">0</h3>
                            <p>Rata-rata Skor</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-trophy fa-2x"></i>
                            <h3 id="classBestScore">0</h3>
                            <p>Skor Tertinggi</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-check-circle fa-2x"></i>
                            <h3 id="classCompletion">0%</h3>
                            <p>Completion Rate</p>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Table -->
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Total Hari</th>
                                <th>Total Poin</th>
                                <th>Rata-rata</th>
                                <th>Skor Tertinggi</th>
                                <th>Completion</th>
                                <th>Detail</th>
                            </tr>
                        </thead>
                        <tbody id="progressList">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 30px;">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data progress...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Progress Summary -->
                <div id="progressSummary" style="margin-top: 30px; padding: 20px; background: #e8f4fd; border-radius: 8px; display: none;">
                    <h4><i class="fas fa-chart-pie"></i> Progress Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 15px;">
                        <div>
                            <canvas id="progressChart" width="400" height="200"></canvas>
                        </div>
                        <div>
                            <div id="summaryStats">
                                <!-- Summary stats will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reporting Section -->
            <section id="reporting" class="admin-section" style="display: none;">
                <h2><i class="fas fa-file-alt"></i> Reporting & Analytics</h2>
                
                <!-- Report Type Selection -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-clipboard-list"></i> Pilih Jenis Laporan</h4>
                    <div class="quick-actions">
                        <div class="action-btn" onclick="generateDailyReport()">
                            <i class="fas fa-calendar-day fa-2x"></i>
                            <p>Laporan Harian</p>
                        </div>
                        <div class="action-btn" onclick="generateMonthlyReport()">
                            <i class="fas fa-calendar-alt fa-2x"></i>
                            <p>Laporan Bulanan</p>
                        </div>
                        <div class="action-btn" onclick="generateClassReport()">
                            <i class="fas fa-school fa-2x"></i>
                            <p>Laporan Per Kelas</p>
                        </div>
                        <div class="action-btn" onclick="generateStudentReport()">
                            <i class="fas fa-user-graduate fa-2x"></i>
                            <p>Laporan Per Siswa</p>
                        </div>
                        <div class="action-btn" onclick="generateHabitsReport()">
                            <i class="fas fa-chart-pie fa-2x"></i>
                            <p>Analisis Kebiasaan</p>
                        </div>
                    </div>
                </div>
                
                <!-- Report Filters -->
                <div id="reportFilters" style="display: none; background: #e8f4fd; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-filter"></i> Filter Laporan</h4>
                    <div id="filterContainer">
                        <!-- Filters will be loaded based on report type -->
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button onclick="generateReport()" class="btn-primary">
                            <i class="fas fa-play"></i> Generate Report
                        </button>
                        <button onclick="cancelReport()" class="btn-logout">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
                
                <!-- Report Results -->
                <div id="reportResults" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4><i class="fas fa-file-excel"></i> Hasil Laporan</h4>
                        <div>
                            <button onclick="printReport()" class="btn-primary">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button onclick="downloadReport()" class="btn-admin">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                            <button onclick="exportReportToExcel()" class="btn-primary">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Header -->
                    <div id="reportHeader" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #2196F3;">
                        <!-- Report header will be loaded here -->
                    </div>
                    
                    <!-- Report Content -->
                    <div id="reportContent">
                        <!-- Report content will be loaded here -->
                    </div>
                    
                    <!-- Report Charts -->
                    <div id="reportCharts" style="margin-top: 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <canvas id="reportChart1" width="400" height="300"></canvas>
                            </div>
                            <div>
                                <canvas id="reportChart2" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h4><i class="fas fa-bolt"></i> Quick Statistics</h4>
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card" onclick="generateDailyReport()" style="cursor: pointer;">
                            <i class="fas fa-sun" style="color: #FF9800; font-size: 2rem;"></i>
                            <h3 id="todayActive">0</h3>
                            <p>Aktif Hari Ini</p>
                        </div>
                        <div class="stat-card" onclick="generateMonthlyReport()" style="cursor: pointer;">
                            <i class="fas fa-calendar-alt" style="color: #4CAF50; font-size: 2rem;"></i>
                            <h3 id="monthlyAvg">0</h3>
                            <p>Rata-rata Bulanan</p>
                        </div>
                        <div class="stat-card" onclick="generateClassReport()" style="cursor: pointer;">
                            <i class="fas fa-school" style="color: #2196F3; font-size: 2rem;"></i>
                            <h3 id="totalClasses">0</h3>
                            <p>Total Kelas</p>
                        </div>
                        <div class="stat-card" onclick="generateHabitsReport()" style="cursor: pointer;">
                            <i class="fas fa-star" style="color: #FFD700; font-size: 2rem;"></i>
                            <h3 id="totalPoints">0</h3>
                            <p>Total Poin</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Statistics Section -->
            <section id="stats" class="admin-section" style="display: none;">
                <h2><i class="fas fa-chart-bar"></i> Statistik Sistem</h2>
                
                <!-- Chart Container -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                    <div class="chart-box">
                        <h3>Distribusi Pengguna</h3>
                        <canvas id="userChart" width="400" height="300"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Aktivitas Harian</h3>
                        <canvas id="activityChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <!-- Detailed Stats -->
                <div class="stats-grid" style="margin-top: 40px;">
                    <div class="stat-card">
                        <i class="fas fa-users fa-2x" style="color: #2196F3;"></i>
                        <h3 id="totalUsersStat">0</h3>
                        <p>Total Pengguna</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-shield fa-2x" style="color: #4CAF50;"></i>
                        <h3 id="adminUsersStat">0</h3>
                        <p>Admin</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-history fa-2x" style="color: #FF9800;"></i>
                        <h3 id="totalHabitsStat">0</h3>
                        <p>Data Kebiasaan</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-alt fa-2x" style="color: #9C27B0;"></i>
                        <h3 id="avgHabitsStat">0</h3>
                        <p>Rata-rata/Hari</p>
                    </div>
                </div>
                
                <!-- Top Users -->
                <div style="margin-top: 40px;">
                    <h3><i class="fas fa-trophy"></i> Top 5 Pengguna Aktif</h3>
                    <div id="topUsers" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 100px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat data...
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Info Section -->
            <section id="system" class="admin-section" style="display: none;">
                <h2><i class="fas fa-cog"></i> System Information</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                    <!-- Database Info -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                        <h4><i class="fas fa-database"></i> Database Status</h4>
                        <div style="margin-top: 15px;">
                            <p><strong>Firebase Connection:</strong> 
                                <span id="firebaseStatus" style="color: #4CAF50;">‚úÖ Connected</span>
                            </p>
                            <p><strong>Last Sync:</strong> <span id="lastSync">-</span></p>
                            <p><strong>Collections:</strong> 
                                <span id="collectionsCount">Loading...</span>
                            </p>
                            <p><strong>Total Documents:</strong> 
                                <span id="totalDocuments">Loading...</span>
                            </p>
                        </div>
                        <button onclick="testDatabaseConnection()" class="btn-primary" style="margin-top: 15px;">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </div>
                    
                    <!-- System Health -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                        <h4><i class="fas fa-heartbeat"></i> System Health</h4>
                        <div style="margin-top: 15px;">
                            <p><strong>Browser:</strong> <span id="browserInfo">-</span></p>
                            <p><strong>Screen Resolution:</strong> <span id="screenResolution">-</span></p>
                            <p><strong>Local Storage:</strong> <span id="localStorageStatus">-</span></p>
                            <p><strong>Memory Usage:</strong> <span id="memoryUsage">-</span></p>
                        </div>
                        <button onclick="clearAdminCache()" class="btn-logout" style="margin-top: 15px;">
                            <i class="fas fa-trash"></i> Clear Cache
                        </button>
                    </div>
                </div>
                
                <!-- Backup & Restore -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h4><i class="fas fa-download"></i> Backup & Restore</h4>
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <button onclick="backupDatabase()" class="btn-primary" style="flex: 1; padding: 15px;">
                            <i class="fas fa-download"></i> Backup Database
                        </button>
                        <button onclick="restoreDatabase()" class="btn-admin" style="flex: 1; padding: 15px;">
                            <i class="fas fa-upload"></i> Restore Database
                        </button>
                    </div>
                    <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i> Backup akan mendownload semua data dalam format JSON
                    </p>
                </div>
                
                <!-- System Time -->
                <div style="margin-top: 30px; background: #e3f2fd; padding: 15px; border-radius: 8px;">
                    <h4><i class="fas fa-clock"></i> System Time</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div>
                            <strong>Waktu Server:</strong> <span id="serverTime">-</span>
                        </div>
                        <div>
                            <strong>Waktu Lokal:</strong> <span id="localTime">-</span>
                        </div>
                        <div>
                            <strong>Timezone:</strong> <span id="timezone">-</span>
                        </div>
                        <div>
                            <strong>Uptime:</strong> <span id="uptime">-</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ==============================================
        // GLOBAL VARIABLES
        // ==============================================
        let currentPage = 1;
        const usersPerPage = 10;
        let allUsers = [];
        let filteredUsers = [];
        let excelImportData = [];
        let userChartInstance = null;
        let activityChartInstance = null;
        let progressData = [];
        let currentProgressFilters = {
            kelas: 'all',
            sort: 'name'
        };
        let currentReportType = '';
        let currentReportData = null;
        let classes = [];

        // ==============================================
        // DATA LOADING FUNCTIONS - PERBAIKAN UTAMA
        // ==============================================

        async function loadClasses() {
            console.log("üìö Memulai loadClasses...");
            
            try {
                // Coba ambil dari collection 'classes' di Firestore
                if (typeof db !== 'undefined') {
                    const snapshot = await db.collection('classes').get();
                    
                    if (!snapshot.empty) {
                        classes = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        console.log(`‚úÖ ${classes.length} kelas ditemukan di Firestore:`, classes.map(c => c.nama));
                    } else {
                        console.log("‚ö†Ô∏è Tidak ada data kelas di collection 'classes'");
                        
                        // Coba extract kelas dari data users yang ada
                        await extractClassesFromUsers();
                    }
                } else {
                    console.error("‚ùå Firestore tidak tersedia");
                    await extractClassesFromUsers();
                }
                
                // Jika masih kosong, gunakan kelas default
                if (!classes || classes.length === 0) {
                    console.log("‚ö†Ô∏è Menggunakan kelas default");
                    classes = getDefaultClasses();
                }
                
                // Urutkan kelas
                classes.sort((a, b) => {
                    // Extract number and letter from class name
                    const extractClassInfo = (nama) => {
                        const match = nama.match(/(\d+)([A-Z])?/i);
                        if (match) {
                            return {
                                number: parseInt(match[1]),
                                letter: match[2] ? match[2].toUpperCase() : ''
                            };
                        }
                        return { number: 0, letter: '' };
                    };
                    
                    const aInfo = extractClassInfo(a.nama);
                    const bInfo = extractClassInfo(b.nama);
                    
                    if (aInfo.number !== bInfo.number) {
                        return aInfo.number - bInfo.number;
                    }
                    return aInfo.letter.localeCompare(bInfo.letter);
                });
                
                console.log("üìä Kelas yang akan digunakan:", classes.map(c => c.nama));
                
                // Populate dropdowns
                populateClassSelects();
                
                // Buat kelas di Firestore jika belum ada
                await createMissingClassesInFirestore();
                
            } catch (error) {
                console.error("‚ùå Error dalam loadClasses:", error);
                // Gunakan fallback
                await extractClassesFromUsers();
            }
        }

        async function extractClassesFromUsers() {
            console.log("üîç Mengekstrak kelas dari data users...");
            
            try {
                // Ambil semua users untuk ekstrak kelas
                const usersSnapshot = await db.collection('users').get();
                const uniqueClasses = new Set();
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.kelas && user.kelas.trim() !== '') {
                        // Normalize class name: "kelas 6A" -> "Kelas 6A"
                        let normalizedKelas = user.kelas.trim();
                        
                        // Capitalize first letter if needed
                        if (normalizedKelas.toLowerCase().startsWith('kelas')) {
                            normalizedKelas = 'Kelas' + normalizedKelas.substring(5);
                        } else if (!normalizedKelas.startsWith('Kelas')) {
                            normalizedKelas = 'Kelas ' + normalizedKelas;
                        }
                        
                        uniqueClasses.add(normalizedKelas);
                    }
                });
                
                // Convert to array
                classes = Array.from(uniqueClasses).map((nama, index) => ({
                    id: `temp_${index + 1}`,
                    nama: nama,
                    tingkat: extractGradeLevel(nama),
                    section: extractSection(nama)
                }));
                
                console.log(`‚úÖ ${classes.length} kelas diekstrak dari users:`, Array.from(uniqueClasses));
                
            } catch (error) {
                console.error("‚ùå Error extracting classes from users:", error);
                classes = getDefaultClasses();
            }
        }

        function extractGradeLevel(className) {
            const match = className.match(/\d+/);
            return match ? match[0] : '';
        }

        function extractSection(className) {
            const match = className.match(/\d+([A-Z])/i);
            return match ? match[1].toUpperCase() : '';
        }

        function getDefaultClasses() {
            return [
                { id: 'default_1', nama: 'Kelas 5A', tingkat: '5', section: 'A' },
                { id: 'default_2', nama: 'Kelas 5B', tingkat: '5', section: 'B' },
                { id: 'default_3', nama: 'Kelas 6A', tingkat: '6', section: 'A' },
                { id: 'default_4', nama: 'Kelas 6B', tingkat: '6', section: 'B' }
            ];
        }

        async function createMissingClassesInFirestore() {
            try {
                if (typeof db === 'undefined') return;
                
                const existingSnapshot = await db.collection('classes').get();
                const existingClassNames = existingSnapshot.docs.map(doc => doc.data().nama);
                
                const batch = db.batch();
                let newClassesCount = 0;
                
                for (const kelas of classes) {
                    if (!existingClassNames.includes(kelas.nama) && !kelas.id.startsWith('temp_')) {
                        const newClassRef = db.collection('classes').doc();
                        batch.set(newClassRef, {
                            nama: kelas.nama,
                            tingkat: kelas.tingkat || extractGradeLevel(kelas.nama),
                            section: kelas.section || extractSection(kelas.nama),
                            createdAt: new Date().toISOString(),
                            createdBy: getCurrentUser().nama,
                            autoCreated: true
                        });
                        newClassesCount++;
                    }
                }
                
                if (newClassesCount > 0) {
                    await batch.commit();
                    console.log(`‚úÖ ${newClassesCount} kelas baru dibuat di Firestore`);
                }
                
            } catch (error) {
                console.error("‚ùå Error creating classes in Firestore:", error);
            }
        }

        function populateClassSelects() {
            console.log("üîÑ Memulai populateClassSelects...");
            
            // List semua dropdown kelas
            const classSelects = [
                'filterKelas',        // Di Manage Users
                'progressKelas',      // Di Progress Tracking
                'userKelas',          // Di Add User
                'reportClassDaily',   // Di Daily Report
                'reportClassMonthly', // Di Monthly Report
                'reportClass'         // Di Class Report
            ];
            
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    console.log(`üìù Mengisi dropdown ${selectId}...`);
                    
                    // Simpan nilai yang sedang dipilih
                    const currentValue = select.value;
                    
                    // Kosongkan dropdown
                    select.innerHTML = '';
                    
                    // Tambah opsi default
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'all';
                    
                    if (selectId === 'userKelas') {
                        defaultOption.textContent = 'Pilih Kelas';
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                    } else {
                        defaultOption.textContent = 'Semua Kelas';
                    }
                    
                    select.appendChild(defaultOption);
                    
                    // Tambah opsi kelas
                    if (classes && classes.length > 0) {
                        classes.forEach(kelas => {
                            const option = document.createElement('option');
                            option.value = kelas.nama;
                            option.textContent = kelas.nama;
                            select.appendChild(option);
                        });
                    } else {
                        // Fallback jika classes kosong
                        const fallbackClasses = ['Kelas 5A', 'Kelas 5B', 'Kelas 6A', 'Kelas 6B'];
                        fallbackClasses.forEach(nama => {
                            const option = document.createElement('option');
                            option.value = nama;
                            option.textContent = nama;
                            select.appendChild(option);
                        });
                    }
                    
                    // Kembalikan nilai yang sebelumnya dipilih
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                    
                    console.log(`‚úÖ ${selectId} diisi dengan ${select.options.length} opsi`);
                }
            });
        }

        // ==============================================
        // STATISTICS FUNCTIONS
        // ==============================================

        async function loadStatistics() {
            console.log("üìä Loading statistics...");
            
            try {
                // Basic stats
                const totalUsers = allUsers.length;
                const adminUsers = allUsers.filter(u => u.role === 'admin').length;
                const regularUsers = totalUsers - adminUsers;
                
                // Update dashboard stats
                document.getElementById('totalUsersAdmin').textContent = totalUsers;
                document.getElementById('adminUsers').textContent = adminUsers;
                document.getElementById('regularUsers').textContent = regularUsers;
                
                // Update statistics section
                document.getElementById('totalUsersStat').textContent = totalUsers;
                document.getElementById('adminUsersStat').textContent = adminUsers;
                
                // Load habits data
                await loadHabitsStatistics();
                
                // Update charts
                updateUserChart(regularUsers, adminUsers);
                
                console.log("‚úÖ Statistics loaded successfully");
                
            } catch (error) {
                console.error("‚ùå Statistics load error:", error);
                throw error;
            }
        }

        async function loadHabitsStatistics() {
            try {
                if (typeof db !== 'undefined') {
                    const snapshot = await db.collection('habits').get();
                    const totalHabits = snapshot.size;
                    
                    // Calculate average per day (last 30 days)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const recentHabits = snapshot.docs.filter(doc => {
                        const data = doc.data();
                        return new Date(data.date) >= thirtyDaysAgo;
                    });
                    
                    const avgPerDay = (recentHabits.length / 30).toFixed(1);
                    
                    // Update UI
                    document.getElementById('totalHabits').textContent = totalHabits;
                    document.getElementById('totalHabitsStat').textContent = totalHabits;
                    document.getElementById('avgHabitsStat').textContent = avgPerDay;
                    
                    // Load top users
                    await loadTopUsers(snapshot);
                    
                } else {
                    document.getElementById('totalHabits').textContent = 'N/A';
                    document.getElementById('totalHabitsStat').textContent = 'N/A';
                    document.getElementById('avgHabitsStat').textContent = 'N/A';
                }
            } catch (error) {
                console.error("‚ùå Habits stats error:", error);
                document.getElementById('totalHabits').textContent = 'Error';
                document.getElementById('totalHabitsStat').textContent = 'Error';
                document.getElementById('avgHabitsStat').textContent = 'Error';
            }
        }

        async function loadTopUsers(habitsSnapshot) {
            try {
                // Count habits per user
                const userHabitsCount = {};
                
                habitsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const userName = data.userName;
                    
                    if (userName) {
                        userHabitsCount[userName] = (userHabitsCount[userName] || 0) + 1;
                    }
                });
                
                // Convert to array and sort
                const topUsersArray = Object.entries(userHabitsCount)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                // Display top users
                const topUsersDiv = document.getElementById('topUsers');
                if (topUsersArray.length > 0) {
                    let html = '<div style="display: grid; gap: 10px;">';
                    
                    topUsersArray.forEach((user, index) => {
                        const percentage = Math.round((user.count / habitsSnapshot.size) * 100);
                        html += `
                            <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #2196F3; width: 30px;">
                                    ${index + 1}
                                </div>
                                <div style="flex: 1;">
                                    <strong>${user.name}</strong>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        ${user.count} data kebiasaan
                                    </div>
                                </div>
                                <div style="background: #4CAF50; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold;">
                                    ${percentage}%
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    topUsersDiv.innerHTML = html;
                } else {
                    topUsersDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-users"></i><br>
                            Belum ada data kebiasaan
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("‚ùå Top users error:", error);
                document.getElementById('topUsers').innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Gagal memuat data
                    </div>
                `;
            }
        }

        // ==============================================
        // USER PROGRESS FUNCTIONS
        // ==============================================

        async function getUserProgress(userId) {
            try {
                const snapshot = await db.collection('habits')
                    .where('userId', '==', userId)
                    .get();
                
                if (snapshot.empty) {
                    return {
                        totalDays: 0,
                        totalPoints: 0,
                        averageScore: 0,
                        bestScore: 0,
                        completionRate: 0
                    };
                }
                
                let totalPoints = 0;
                let totalDays = snapshot.size;
                let bestScore = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const points = data.points || 0;
                    totalPoints += points;
                    
                    if (points > bestScore) {
                        bestScore = points;
                    }
                });
                
                const averageScore = totalDays > 0 ? (totalPoints / totalDays).toFixed(1) : 0;
                const completionRate = Math.round((totalDays / 30) * 100);
                
                return {
                    totalDays,
                    totalPoints,
                    averageScore,
                    bestScore,
                    completionRate: Math.min(completionRate, 100)
                };
                
            } catch (error) {
                console.error("‚ùå Error getting user progress:", error);
                return {
                    totalDays: 0,
                    totalPoints: 0,
                    averageScore: 0,
                    bestScore: 0,
                    completionRate: 0
                };
            }
        }

        // ==============================================
        // PROGRESS TRACKING FUNCTIONS - DIPERBAIKI
        // ==============================================

        async function loadProgressData() {
            console.log("üìà Loading progress data...");
            
            try {
                // Get filters
                const kelasFilter = document.getElementById('progressKelas').value;
                const sortOption = document.getElementById('progressSort').value;
                
                currentProgressFilters = {
                    kelas: kelasFilter,
                    sort: sortOption
                };
                
                // Clear progress data
                progressData = [];
                const progressList = document.getElementById('progressList');
                progressList.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat data progress...
                        </td>
                    </tr>
                `;
                
                // Filter users based on class
                let filteredUsers = [...allUsers];
                
                if (kelasFilter !== 'all') {
                    const normalizedKelas = normalizeClassName(kelasFilter);
                    filteredUsers = allUsers.filter(user => 
                        user.role === 'user' && 
                        user.kelas === normalizedKelas
                    );
                } else {
                    filteredUsers = allUsers.filter(user => user.role === 'user');
                }
                
                console.log(`Filtered ${filteredUsers.length} users for progress tracking`);
                
                // Get progress for each user
                const progressPromises = filteredUsers.map(async (user) => {
                    const progress = await getUserProgress(user.id);
                    
                    return {
                        userId: user.id,
                        userName: user.nama,
                        userKelas: user.kelas || '-',
                        ...progress,
                        // Calculate completion rate based on 30 days
                        completionRate: progress.totalDays > 0 ? 
                            Math.min(Math.round((progress.totalDays / 30) * 100), 100) : 0
                    };
                });
                
                progressData = await Promise.all(progressPromises);
                
                // Sort data
                progressData.sort((a, b) => {
                    switch(sortOption) {
                        case 'name_desc':
                            return b.userName.localeCompare(a.userName);
                        case 'score':
                            return b.averageScore - a.averageScore;
                        case 'days':
                            return b.totalDays - a.totalDays;
                        default: // 'name'
                            return a.userName.localeCompare(b.userName);
                    }
                });
                
                // Display progress data
                displayProgressData();
                
                // Show class statistics if class filter is selected
                if (kelasFilter !== 'all') {
                    calculateClassStatistics(kelasFilter);
                } else {
                    document.getElementById('classStats').style.display = 'none';
                }
                
                console.log(`‚úÖ Progress data loaded: ${progressData.length} records`);
                
            } catch (error) {
                console.error("‚ùå Error loading progress data:", error);
                document.getElementById('progressList').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #f44336; padding: 30px;">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Gagal memuat data progress: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function displayProgressData() {
            const progressList = document.getElementById('progressList');
            
            if (progressData.length === 0) {
                progressList.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-chart-line"></i><br>
                            Tidak ada data progress untuk ditampilkan
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            progressData.forEach((item, index) => {
                // Determine completion color
                let completionClass = 'completion-none';
                if (item.completionRate >= 80) completionClass = 'completion-excellent';
                else if (item.completionRate >= 60) completionClass = 'completion-good';
                else if (item.completionRate > 0) completionClass = 'completion-poor';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${item.userName}</strong></td>
                        <td>${item.userKelas}</td>
                        <td>${item.totalDays} hari</td>
                        <td>${item.totalPoints} poin</td>
                        <td>${item.averageScore}</td>
                        <td>${item.bestScore}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 100px;">
                                    <div class="progress-bar-small">
                                        <div class="progress-fill-small ${completionClass}" 
                                             style="width: ${item.completionRate}%"></div>
                                    </div>
                                </div>
                                <span>${item.completionRate}%</span>
                            </div>
                        </td>
                        <td>
                            <button onclick="viewStudentDetail('${item.userId}')" 
                                    class="btn-primary" style="padding: 5px 10px;">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            progressList.innerHTML = html;
        }

        function calculateClassStatistics(kelas) {
            const normalizedKelas = normalizeClassName(kelas);
            const classStudents = progressData.filter(item => 
                item.userKelas === normalizedKelas
            );
            
            if (classStudents.length === 0) {
                document.getElementById('classStats').style.display = 'none';
                return;
            }
            
            // Calculate statistics
            const totalStudents = classStudents.length;
            const totalScore = classStudents.reduce((sum, student) => 
                sum + parseFloat(student.averageScore), 0);
            const averageScore = (totalScore / totalStudents).toFixed(1);
            const bestScore = Math.max(...classStudents.map(s => s.bestScore));
            const completionRate = classStudents.length > 0 ? 
                Math.round(classStudents.reduce((sum, student) => 
                    sum + student.completionRate, 0) / totalStudents) : 0;
            
            // Update UI
            document.getElementById('classTotalStudents').textContent = totalStudents;
            document.getElementById('classAverageScore').textContent = averageScore;
            document.getElementById('classBestScore').textContent = bestScore;
            document.getElementById('classCompletion').textContent = completionRate + '%';
            
            // Show statistics
            document.getElementById('classStats').style.display = 'block';
        }

        function resetProgressFilters() {
            document.getElementById('progressKelas').value = 'all';
            document.getElementById('progressSort').value = 'name';
            loadProgressData();
        }

        async function exportProgressToExcel() {
            try {
                if (progressData.length === 0) {
                    alert('‚ö†Ô∏è Tidak ada data progress untuk di-export!');
                    return;
                }
                
                // Prepare CSV content
                let csvContent = "Nama,Kelas,Total Hari,Total Poin,Rata-rata Poin,Skor Tertinggi,Completion Rate\n";
                
                progressData.forEach(item => {
                    csvContent += `"${item.userName}","${item.userKelas}",${item.totalDays},${item.totalPoints},${item.averageScore},${item.bestScore},${item.completionRate}%\n`;
                });
                
                // Create download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const dateStr = new Date().toISOString().split('T')[0];
                const kelasFilter = document.getElementById('progressKelas').value;
                const fileName = kelasFilter === 'all' ? 
                    `progress_all_${dateStr}.csv` : 
                    `progress_${kelasFilter}_${dateStr}.csv`;
                
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Progress data berhasil diexport: ${progressData.length} records`);
                
            } catch (error) {
                alert('‚ùå Gagal export progress: ' + error.message);
            }
        }

        function viewStudentDetail(userId) {
            // Switch to reporting section and generate student report
            document.querySelector('a[href="#reporting"]').click();
            setTimeout(() => {
                generateStudentReport(userId);
            }, 500);
        }

        // ==============================================
        // REPORTING FUNCTIONS - DITAMBAHKAN
        // ==============================================

        function generateDailyReport() {
            currentReportType = 'daily';
            
            // Show filter section
            document.getElementById('reportFilters').style.display = 'block';
            
            // Create filter UI
            const filterContainer = document.getElementById('filterContainer');
            filterContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label for="reportDateDaily">Tanggal</label>
                        <input type="date" id="reportDateDaily" style="width: 100%; padding: 10px;" 
                               value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label for="reportClassDaily">Kelas</label>
                        <select id="reportClassDaily" style="width: 100%; padding: 10px;">
                            <option value="all">Semua Kelas</option>
                            <!-- Kelas akan diisi secara dinamis -->
                        </select>
                    </div>
                    <div>
                        <label for="reportStudentDaily">Siswa</label>
                        <select id="reportStudentDaily" style="width: 100%; padding: 10px;">
                            <option value="all">Semua Siswa</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Populate classes dropdown
            populateReportClassDropdown('reportClassDaily');
            
            // Populate students dropdown
            populateStudentsDropdown('reportStudentDaily');
        }

        function generateMonthlyReport() {
            currentReportType = 'monthly';
            
            document.getElementById('reportFilters').style.display = 'block';
            
            const filterContainer = document.getElementById('filterContainer');
            filterContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label for="reportMonth">Bulan</label>
                        <input type="month" id="reportMonth" style="width: 100%; padding: 10px;" 
                               value="${new Date().toISOString().substring(0, 7)}">
                    </div>
                    <div>
                        <label for="reportClassMonthly">Kelas</label>
                        <select id="reportClassMonthly" style="width: 100%; padding: 10px;">
                            <option value="all">Semua Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportStudentMonthly">Siswa</label>
                        <select id="reportStudentMonthly" style="width: 100%; padding: 10px;">
                            <option value="all">Semua Siswa</option>
                        </select>
                    </div>
                </div>
            `;
            
            populateReportClassDropdown('reportClassMonthly');
            populateStudentsDropdown('reportStudentMonthly');
        }

        function generateClassReport() {
            currentReportType = 'class';
            
            document.getElementById('reportFilters').style.display = 'block';
            
            const filterContainer = document.getElementById('filterContainer');
            filterContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label for="reportClass">Kelas</label>
                        <select id="reportClass" style="width: 100%; padding: 10px;">
                            <option value="all">Semua Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportDateRange">Periode</label>
                        <select id="reportDateRange" style="width: 100%; padding: 10px;">
                            <option value="today">Hari Ini</option>
                            <option value="week">7 Hari Terakhir</option>
                            <option value="month">Bulan Ini</option>
                            <option value="lastmonth">Bulan Lalu</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div id="customDateRange" style="display: none; grid-column: span 2;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="reportStartDate">Dari Tanggal</label>
                                <input type="date" id="reportStartDate" style="width: 100%; padding: 10px;">
                            </div>
                            <div>
                                <label for="reportEndDate">Sampai Tanggal</label>
                                <input type="date" id="reportEndDate" style="width: 100%; padding: 10px;">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            populateReportClassDropdown('reportClass');
            
            // Show custom date range when selected
            document.getElementById('reportDateRange').addEventListener('change', function() {
                const customDiv = document.getElementById('customDateRange');
                customDiv.style.display = this.value === 'custom' ? 'block' : 'none';
            });
        }

        function generateStudentReport(preSelectedUserId = null) {
            currentReportType = 'student';
            
            document.getElementById('reportFilters').style.display = 'block';
            
            const filterContainer = document.getElementById('filterContainer');
            filterContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label for="reportStudent">Siswa</label>
                        <select id="reportStudent" style="width: 100%; padding: 10px;">
                            <option value="">Pilih Siswa</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportDateRangeStudent">Periode</label>
                        <select id="reportDateRangeStudent" style="width: 100%; padding: 10px;">
                            <option value="today">Hari Ini</option>
                            <option value="week">7 Hari Terakhir</option>
                            <option value="month">Bulan Ini</option>
                            <option value="lastmonth">Bulan Lalu</option>
                            <option value="alltime">Semua Waktu</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div id="customDateRangeStudent" style="display: none; grid-column: span 2;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="reportStartDateStudent">Dari Tanggal</label>
                                <input type="date" id="reportStartDateStudent" style="width: 100%; padding: 10px;">
                            </div>
                            <div>
                                <label for="reportEndDateStudent">Sampai Tanggal</label>
                                <input type="date" id="reportEndDateStudent" style="width: 100%; padding: 10px;">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            populateStudentsDropdown('reportStudent', preSelectedUserId);
            
            document.getElementById('reportDateRangeStudent').addEventListener('change', function() {
                const customDiv = document.getElementById('customDateRangeStudent');
                customDiv.style.display = this.value === 'custom' ? 'block' : 'none';
            });
        }

        function generateHabitsReport() {
            alert("Fitur Analisis Kebiasaan akan tersedia di versi mendatang.");
        }

        function populateReportClassDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Clear and add default option
            select.innerHTML = '<option value="all">Semua Kelas</option>';
            
            // Add class options
            classes.forEach(kelas => {
                const option = document.createElement('option');
                option.value = kelas.nama;
                option.textContent = kelas.nama;
                select.appendChild(option);
            });
        }

        function populateStudentsDropdown(selectId, preSelectedUserId = null) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Clear existing options
            select.innerHTML = '<option value="all">Semua Siswa</option>';
            
            // Get all regular users (non-admin)
            const students = allUsers.filter(user => user.role === 'user');
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.nama} (${student.kelas || '-'})`;
                select.appendChild(option);
            });
            
            // Pre-select if specified
            if (preSelectedUserId && select.querySelector(`option[value="${preSelectedUserId}"]`)) {
                select.value = preSelectedUserId;
            }
        }

        async function generateReport() {
            try {
                console.log(`Generating ${currentReportType} report...`);
                
                // Show loading
                document.getElementById('reportResults').style.display = 'block';
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Membuat laporan...</p>
                    </div>
                `;
                
                let reportData;
                
                switch(currentReportType) {
                    case 'daily':
                        reportData = await generateDailyReportData();
                        break;
                    case 'monthly':
                        reportData = await generateMonthlyReportData();
                        break;
                    case 'class':
                        reportData = await generateClassReportData();
                        break;
                    case 'student':
                        reportData = await generateStudentReportData();
                        break;
                    default:
                        throw new Error('Tipe laporan tidak valid');
                }
                
                currentReportData = reportData;
                
                // Display report
                displayReport(reportData);
                
            } catch (error) {
                console.error("‚ùå Report generation error:", error);
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 40px;">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p>Gagal membuat laporan: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function generateDailyReportData() {
            const date = document.getElementById('reportDateDaily').value;
            const kelas = document.getElementById('reportClassDaily').value;
            const studentId = document.getElementById('reportStudentDaily').value;
            
            if (!date) {
                throw new Error('Tanggal harus diisi');
            }
            
            // Build query
            let query = db.collection('habits').where('date', '==', date);
            
            // Apply filters
            const habitsSnapshot = await query.get();
            let habitsData = [];
            
            habitsSnapshot.forEach(doc => {
                habitsData.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Filter by class
            if (kelas !== 'all') {
                const normalizedKelas = normalizeClassName(kelas);
                
                // Get users in this class
                const classUsers = allUsers.filter(user => 
                    user.role === 'user' && user.kelas === normalizedKelas
                );
                
                const classUserIds = classUsers.map(u => u.id);
                habitsData = habitsData.filter(habit => classUserIds.includes(habit.userId));
            }
            
            // Filter by student
            if (studentId !== 'all') {
                habitsData = habitsData.filter(habit => habit.userId === studentId);
            }
            
            return {
                type: 'daily',
                date: date,
                class: kelas,
                studentId: studentId,
                totalEntries: habitsData.length,
                habits: habitsData,
                summary: calculateDailySummary(habitsData)
            };
        }

        async function generateMonthlyReportData() {
            const month = document.getElementById('reportMonth').value;
            const kelas = document.getElementById('reportClassMonthly').value;
            const studentId = document.getElementById('reportStudentMonthly').value;
            
            if (!month) {
                throw new Error('Bulan harus diisi');
            }
            
            // Calculate date range for month
            const [year, monthNum] = month.split('-').map(Number);
            const startDate = `${year}-${monthNum.toString().padStart(2, '0')}-01`;
            const endDate = `${year}-${monthNum.toString().padStart(2, '0')}-${new Date(year, monthNum, 0).getDate()}`;
            
            // Get habits for month
            let query = db.collection('habits')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate);
            
            const habitsSnapshot = await query.get();
            let habitsData = [];
            
            habitsSnapshot.forEach(doc => {
                habitsData.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Filter by class
            if (kelas !== 'all') {
                const normalizedKelas = normalizeClassName(kelas);
                const classUsers = allUsers.filter(user => 
                    user.role === 'user' && user.kelas === normalizedKelas
                );
                const classUserIds = classUsers.map(u => u.id);
                habitsData = habitsData.filter(habit => classUserIds.includes(habit.userId));
            }
            
            // Filter by student
            if (studentId !== 'all') {
                habitsData = habitsData.filter(habit => habit.userId === studentId);
            }
            
            return {
                type: 'monthly',
                month: month,
                class: kelas,
                studentId: studentId,
                startDate: startDate,
                endDate: endDate,
                totalEntries: habitsData.length,
                habits: habitsData,
                summary: calculateMonthlySummary(habitsData)
            };
        }

        async function generateClassReportData() {
            const kelas = document.getElementById('reportClass').value;
            const dateRange = document.getElementById('reportDateRange').value;
            
            if (kelas === 'all') {
                throw new Error('Pilih kelas terlebih dahulu');
            }
            
            // Calculate date range
            let startDate, endDate;
            const today = new Date();
            
            switch(dateRange) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    startDate = new Date(today.setDate(today.getDate() - 7))
                        .toISOString().split('T')[0];
                    endDate = new Date().toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1)
                        .toISOString().split('T')[0];
                    endDate = new Date().toISOString().split('T')[0];
                    break;
                case 'lastmonth':
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate = lastMonth.toISOString().split('T')[0];
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0)
                        .toISOString().split('T')[0];
                    break;
                case 'custom':
                    startDate = document.getElementById('reportStartDate').value;
                    endDate = document.getElementById('reportEndDate').value;
                    if (!startDate || !endDate) {
                        throw new Error('Tanggal custom harus diisi');
                    }
                    break;
                default:
                    throw new Error('Periode tidak valid');
            }
            
            // Get users in class
            const normalizedKelas = normalizeClassName(kelas);
            const classUsers = allUsers.filter(user => 
                user.role === 'user' && user.kelas === normalizedKelas
            );
            
            if (classUsers.length === 0) {
                throw new Error(`Tidak ada siswa di kelas ${kelas}`);
            }
            
            // Get habits for each student in date range
            const classUserIds = classUsers.map(u => u.id);
            let query = db.collection('habits')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate);
            
            const habitsSnapshot = await query.get();
            let habitsData = [];
            
            habitsSnapshot.forEach(doc => {
                const habit = doc.data();
                if (classUserIds.includes(habit.userId)) {
                    habitsData.push({
                        id: doc.id,
                        ...habit
                    });
                }
            });
            
            return {
                type: 'class',
                kelas: kelas,
                dateRange: dateRange,
                startDate: startDate,
                endDate: endDate,
                totalStudents: classUsers.length,
                totalEntries: habitsData.length,
                habits: habitsData,
                students: classUsers,
                summary: calculateClassReportSummary(habitsData, classUsers)
            };
        }

        async function generateStudentReportData() {
            const studentId = document.getElementById('reportStudent').value;
            const dateRange = document.getElementById('reportDateRangeStudent').value;
            
            if (!studentId) {
                throw new Error('Pilih siswa terlebih dahulu');
            }
            
            // Find student
            const student = allUsers.find(u => u.id === studentId);
            if (!student) {
                throw new Error('Siswa tidak ditemukan');
            }
            
            // Calculate date range
            let query = db.collection('habits').where('userId', '==', studentId);
            
            if (dateRange !== 'alltime') {
                let startDate, endDate;
                const today = new Date();
                
                switch(dateRange) {
                    case 'today':
                        startDate = endDate = today.toISOString().split('T')[0];
                        break;
                    case 'week':
                        startDate = new Date(today.setDate(today.getDate() - 7))
                            .toISOString().split('T')[0];
                        endDate = new Date().toISOString().split('T')[0];
                        break;
                    case 'month':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1)
                            .toISOString().split('T')[0];
                        endDate = new Date().toISOString().split('T')[0];
                        break;
                    case 'lastmonth':
                        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        startDate = lastMonth.toISOString().split('T')[0];
                        endDate = new Date(today.getFullYear(), today.getMonth(), 0)
                            .toISOString().split('T')[0];
                        break;
                    case 'custom':
                        startDate = document.getElementById('reportStartDateStudent').value;
                        endDate = document.getElementById('reportEndDateStudent').value;
                        if (!startDate || !endDate) {
                            throw new Error('Tanggal custom harus diisi');
                        }
                        break;
                }
                
                if (startDate) {
                    query = query.where('date', '>=', startDate);
                }
                if (endDate) {
                    query = query.where('date', '<=', endDate);
                }
            }
            
            const habitsSnapshot = await query.get();
            const habitsData = [];
            
            habitsSnapshot.forEach(doc => {
                habitsData.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Sort by date descending
            habitsData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return {
                type: 'student',
                student: student,
                dateRange: dateRange,
                habits: habitsData,
                summary: calculateStudentReportSummary(habitsData)
            };
        }

        function displayReport(reportData) {
            // Report header
            const reportHeader = document.getElementById('reportHeader');
            let headerHTML = '';
            
            switch(reportData.type) {
                case 'daily':
                    headerHTML = `
                        <h3 style="margin: 0 0 10px 0;">Laporan Harian</h3>
                        <p style="margin: 0; color: #666;">
                            <strong>Tanggal:</strong> ${new Date(reportData.date).toLocaleDateString('id-ID')}
                            ${reportData.class !== 'all' ? ` | <strong>Kelas:</strong> ${reportData.class}` : ''}
                            ${reportData.studentId !== 'all' ? ` | <strong>Siswa:</strong> ${allUsers.find(u => u.id === reportData.studentId)?.nama}` : ''}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9rem;">
                            Generated: ${new Date().toLocaleString('id-ID')} oleh ${getCurrentUser().nama}
                        </p>
                    `;
                    break;
                case 'monthly':
                    headerHTML = `
                        <h3 style="margin: 0 0 10px 0;">Laporan Bulanan</h3>
                        <p style="margin: 0; color: #666;">
                            <strong>Bulan:</strong> ${new Date(reportData.month + '-01').toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}
                            ${reportData.class !== 'all' ? ` | <strong>Kelas:</strong> ${reportData.class}` : ''}
                            ${reportData.studentId !== 'all' ? ` | <strong>Siswa:</strong> ${allUsers.find(u => u.id === reportData.studentId)?.nama}` : ''}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9rem;">
                            Generated: ${new Date().toLocaleString('id-ID')} oleh ${getCurrentUser().nama}
                        </p>
                    `;
                    break;
                case 'class':
                    headerHTML = `
                        <h3 style="margin: 0 0 10px 0;">Laporan Kelas ${reportData.kelas}</h3>
                        <p style="margin: 0; color: #666;">
                            <strong>Periode:</strong> ${new Date(reportData.startDate).toLocaleDateString('id-ID')} - ${new Date(reportData.endDate).toLocaleDateString('id-ID')}
                            | <strong>Total Siswa:</strong> ${reportData.totalStudents}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9rem;">
                            Generated: ${new Date().toLocaleString('id-ID')} oleh ${getCurrentUser().nama}
                        </p>
                    `;
                    break;
                case 'student':
                    headerHTML = `
                        <h3 style="margin: 0 0 10px 0;">Laporan Siswa: ${reportData.student.nama}</h3>
                        <p style="margin: 0; color: #666;">
                            <strong>Kelas:</strong> ${reportData.student.kelas || '-'}
                            | <strong>Periode:</strong> ${reportData.dateRange === 'alltime' ? 'Semua Waktu' : reportData.dateRange}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9rem;">
                            Generated: ${new Date().toLocaleString('id-ID')} oleh ${getCurrentUser().nama}
                        </p>
                    `;
                    break;
            }
            
            reportHeader.innerHTML = headerHTML;
            
            // Report content
            const reportContent = document.getElementById('reportContent');
            let contentHTML = '';
            
            switch(reportData.type) {
                case 'daily':
                case 'monthly':
                    contentHTML = generateHabitsTable(reportData.habits);
                    break;
                case 'class':
                    contentHTML = generateClassReportContent(reportData);
                    break;
                case 'student':
                    contentHTML = generateStudentReportContent(reportData);
                    break;
            }
            
            reportContent.innerHTML = contentHTML;
            
            // Show charts if there's data
            if (reportData.habits && reportData.habits.length > 0) {
                createReportCharts(reportData);
                document.getElementById('reportCharts').style.display = 'block';
            } else {
                document.getElementById('reportCharts').style.display = 'none';
            }
        }

        function generateHabitsTable(habits) {
            if (habits.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-clipboard-list fa-3x"></i>
                        <h4>Tidak ada data untuk ditampilkan</h4>
                    </div>
                `;
            }
            
            // Group by user for better display
            const habitsByUser = {};
            habits.forEach(habit => {
                if (!habitsByUser[habit.userName]) {
                    habitsByUser[habit.userName] = [];
                }
                habitsByUser[habit.userName].push(habit);
            });
            
            let tableHTML = `
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th>Kelas</th>
                                <th>Tanggal</th>
                                <th>Total Poin</th>
                                <th>Habit 1</th>
                                <th>Habit 2</th>
                                <th>Habit 3</th>
                                <th>Habit 4</th>
                                <th>Habit 5</th>
                                <th>Habit 6</th>
                                <th>Habit 7</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let rowNumber = 1;
            for (const [userName, userHabits] of Object.entries(habitsByUser)) {
                userHabits.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                userHabits.forEach(habit => {
                    const habitScores = habit.habits || {};
                    tableHTML += `
                        <tr>
                            <td>${rowNumber++}</td>
                            <td>${userName}</td>
                            <td>${habit.class || '-'}</td>
                            <td>${new Date(habit.date).toLocaleDateString('id-ID')}</td>
                            <td><strong>${habit.points || 0}</strong></td>
                            <td>${habitScores.habit1 || 0}</td>
                            <td>${habitScores.habit2 || 0}</td>
                            <td>${habitScores.habit3 || 0}</td>
                            <td>${habitScores.habit4 || 0}</td>
                            <td>${habitScores.habit5 || 0}</td>
                            <td>${habitScores.habit6 || 0}</td>
                            <td>${habitScores.habit7 || 0}</td>
                        </tr>
                    `;
                });
            }
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div>
                            <strong>Total Entries:</strong> ${habits.length}
                        </div>
                        <div>
                            <strong>Total Points:</strong> ${habits.reduce((sum, h) => sum + (h.points || 0), 0)}
                        </div>
                        <div>
                            <strong>Average Points:</strong> ${(habits.reduce((sum, h) => sum + (h.points || 0), 0) / habits.length).toFixed(1)}
                        </div>
                        <div>
                            <strong>Unique Students:</strong> ${Object.keys(habitsByUser).length}
                        </div>
                    </div>
                </div>
            `;
            
            return tableHTML;
        }

        function generateClassReportContent(reportData) {
            // Calculate statistics for each student
            const studentStats = reportData.students.map(student => {
                const studentHabits = reportData.habits.filter(h => h.userId === student.id);
                const totalPoints = studentHabits.reduce((sum, h) => sum + (h.points || 0), 0);
                const totalDays = studentHabits.length;
                
                return {
                    name: student.nama,
                    totalDays,
                    totalPoints,
                    averagePoints: totalDays > 0 ? (totalPoints / totalDays).toFixed(1) : 0,
                    completionRate: Math.round((totalDays / reportData.totalEntries) * 100) || 0
                };
            });
            
            // Sort by total points (descending)
            studentStats.sort((a, b) => b.totalPoints - a.totalPoints);
            
            let html = `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h4>Ringkasan Kelas</h4>
                        <div class="stats-grid" style="margin-top: 15px;">
                            <div class="stat-card">
                                <h3>${reportData.totalStudents}</h3>
                                <p>Total Siswa</p>
                            </div>
                            <div class="stat-card">
                                <h3>${reportData.totalEntries}</h3>
                                <p>Total Entries</p>
                            </div>
                            <div class="stat-card">
                                <h3>${reportData.habits.length > 0 ? 
                                    (reportData.habits.reduce((sum, h) => sum + (h.points || 0), 0) / reportData.habits.length).toFixed(1) : 0}</h3>
                                <p>Rata-rata Poin</p>
                            </div>
                            <div class="stat-card">
                                <h3>${Math.round(reportData.totalEntries / reportData.totalStudents)}</h3>
                                <p>Entries/Siswa</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4>Top 3 Siswa</h4>
                        <div style="margin-top: 15px;">
            `;
            
            studentStats.slice(0, 3).forEach((student, index) => {
                const colors = ['#FFD700', '#C0C0C0', '#CD7F32'];
                html += `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 10px; margin-bottom: 10px; background: white; border-radius: 8px; border-left: 4px solid ${colors[index]};">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${colors[index]};">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <strong>${student.name}</strong>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${student.totalPoints} poin dalam ${student.totalDays} hari
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
                
                <div class="users-table-container">
                    <h4>Detail Per Siswa</h4>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th>Total Hari</th>
                                <th>Total Poin</th>
                                <th>Rata-rata/Hari</th>
                                <th>Completion</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            studentStats.forEach((student, index) => {
                const completionRate = Math.round((student.totalDays / 30) * 100);
                let completionClass = 'completion-none';
                if (completionRate >= 80) completionClass = 'completion-excellent';
                else if (completionRate >= 60) completionClass = 'completion-good';
                else if (completionRate > 0) completionClass = 'completion-poor';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${student.name}</strong></td>
                        <td>${student.totalDays} hari</td>
                        <td>${student.totalPoints} poin</td>
                        <td>${student.averagePoints}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 80px;">
                                    <div class="progress-bar-small">
                                        <div class="progress-fill-small ${completionClass}" 
                                             style="width: ${completionRate}%"></div>
                                    </div>
                                </div>
                                <span>${completionRate}%</span>
                            </div>
                        </td>
                        <td>
                            <button onclick="generateStudentReport('${reportData.students.find(s => s.nama === student.name)?.id}')" 
                                    class="btn-primary" style="padding: 5px 10px;">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function generateStudentReportContent(reportData) {
            const student = reportData.student;
            const habits = reportData.habits;
            
            if (habits.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-user-graduate fa-3x"></i>
                        <h4>Belum ada data kebiasaan untuk ${student.nama}</h4>
                        <p>${student.nama} belum mengisi tracker kebiasaan pada periode ini.</p>
                    </div>
                `;
            }
            
            // Calculate statistics
            const totalDays = habits.length;
            const totalPoints = habits.reduce((sum, h) => sum + (h.points || 0), 0);
            const averagePoints = (totalPoints / totalDays).toFixed(1);
            const bestScore = Math.max(...habits.map(h => h.points || 0));
            const completionRate = Math.min(Math.round((totalDays / 30) * 100), 100);
            
            // Calculate habit averages
            const habitAverages = {};
            for (let i = 1; i <= 7; i++) {
                const habitKey = `habit${i}`;
                const total = habits.reduce((sum, h) => sum + ((h.habits || {})[habitKey] || 0), 0);
                habitAverages[habitKey] = (total / totalDays).toFixed(1);
            }
            
            let html = `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h4>Ringkasan Prestasi</h4>
                        <div class="stats-grid" style="margin-top: 15px;">
                            <div class="stat-card">
                                <h3>${totalDays}</h3>
                                <p>Total Hari</p>
                            </div>
                            <div class="stat-card">
                                <h3>${totalPoints}</h3>
                                <p>Total Poin</p>
                            </div>
                            <div class="stat-card">
                                <h3>${averagePoints}</h3>
                                <p>Rata-rata/Hari</p>
                            </div>
                            <div class="stat-card">
                                <h3>${bestScore}</h3>
                                <p>Skor Tertinggi</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4>Analisis Kebiasaan</h4>
                        <div style="margin-top: 15px;">
            `;
            
            for (let i = 1; i <= 7; i++) {
                const avg = habitAverages[`habit${i}`];
                const width = Math.min((avg / 3) * 100, 100);
                let color = '#4CAF50';
                if (avg < 1) color = '#f44336';
                else if (avg < 2) color = '#FF9800';
                
                html += `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>Habit ${i}</strong></span>
                            <span>${avg}/3</span>
                        </div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-small" style="width: ${width}%; background: ${color};"></div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
                </div>
                
                <div class="users-table-container">
                    <h4>Detail Harian</h4>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Total Poin</th>
                                <th>Habit 1</th>
                                <th>Habit 2</th>
                                <th>Habit 3</th>
                                <th>Habit 4</th>
                                <th>Habit 5</th>
                                <th>Habit 6</th>
                                <th>Habit 7</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            habits.forEach((habit, index) => {
                const habitScores = habit.habits || {};
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${new Date(habit.date).toLocaleDateString('id-ID')}</td>
                        <td><strong>${habit.points || 0}</strong></td>
                        <td>${habitScores.habit1 || 0}</td>
                        <td>${habitScores.habit2 || 0}</td>
                        <td>${habitScores.habit3 || 0}</td>
                        <td>${habitScores.habit4 || 0}</td>
                        <td>${habitScores.habit5 || 0}</td>
                        <td>${habitScores.habit6 || 0}</td>
                        <td>${habitScores.habit7 || 0}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Catatan</h4>
                    <p>Completion Rate: ${completionRate}% (${totalDays} dari 30 hari)</p>
                    <p>${completionRate >= 80 ? 
                        '‚úÖ Excellent! Siswa sangat konsisten dalam mengisi kebiasaan.' :
                        completionRate >= 60 ? 
                        '‚ö†Ô∏è Good! Siswa cukup konsisten, bisa ditingkatkan lagi.' :
                        '‚ùå Perlu perhatian! Siswa perlu lebih konsisten dalam mengisi kebiasaan.'}
                    </p>
                </div>
            `;
            
            return html;
        }

        function createReportCharts(reportData) {
            // Destroy existing charts
            const charts = ['reportChart1', 'reportChart2'];
            charts.forEach(chartId => {
                const chart = Chart.getChart(chartId);
                if (chart) chart.destroy();
            });
            
            switch(reportData.type) {
                case 'daily':
                case 'monthly':
                    createHabitsDistributionChart(reportData);
                    createPointsTrendChart(reportData);
                    break;
                case 'class':
                    createClassPerformanceChart(reportData);
                    createHabitsAverageChart(reportData);
                    break;
                case 'student':
                    createStudentProgressChart(reportData);
                    createStudentHabitsChart(reportData);
                    break;
            }
        }

        function createHabitsDistributionChart(reportData) {
            const ctx = document.getElementById('reportChart1');
            if (!ctx) return;
            
            // Calculate habit distribution
            const habitCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
            
            reportData.habits.forEach(habit => {
                const scores = habit.habits || {};
                for (let i = 1; i <= 7; i++) {
                    const score = scores[`habit${i}`] || 0;
                    if (score > 0) {
                        habitCounts[i]++;
                    }
                }
            });
            
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Habit 1', 'Habit 2', 'Habit 3', 'Habit 4', 'Habit 5', 'Habit 6', 'Habit 7'],
                    datasets: [{
                        label: 'Jumlah Pengisian',
                        data: Object.values(habitCounts),
                        backgroundColor: '#2196F3',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribusi Pengisian Kebiasaan'
                        }
                    }
                }
            });
        }

        function cancelReport() {
            document.getElementById('reportFilters').style.display = 'none';
            document.getElementById('reportResults').style.display = 'none';
        }

        function printReport() {
            window.print();
        }

        function downloadReport() {
            alert('Fitur download PDF akan tersedia di versi mendatang.');
        }

        function exportReportToExcel() {
            if (!currentReportData) {
                alert('‚ö†Ô∏è Tidak ada data laporan untuk di-export!');
                return;
            }
            
            try {
                let csvContent = '';
                
                switch(currentReportData.type) {
                    case 'daily':
                    case 'monthly':
                        csvContent = exportHabitsToCSV(currentReportData.habits);
                        break;
                    case 'class':
                        csvContent = exportClassReportToCSV(currentReportData);
                        break;
                    case 'student':
                        csvContent = exportStudentReportToCSV(currentReportData);
                        break;
                }
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const dateStr = new Date().toISOString().split('T')[0];
                const fileName = `report_${currentReportData.type}_${dateStr}.csv`;
                
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Laporan berhasil diexport!`);
                
            } catch (error) {
                alert('‚ùå Gagal export laporan: ' + error.message);
            }
        }

        // ==============================================
        // HELPER FUNCTIONS
        // ==============================================

        function calculateDailySummary(habits) {
            if (habits.length === 0) {
                return {
                    totalStudents: 0,
                    totalPoints: 0,
                    averagePoints: 0
                };
            }
            
            const uniqueStudents = [...new Set(habits.map(h => h.userId))];
            const totalPoints = habits.reduce((sum, h) => sum + (h.points || 0), 0);
            
            return {
                totalStudents: uniqueStudents.length,
                totalPoints: totalPoints,
                averagePoints: (totalPoints / habits.length).toFixed(1)
            };
        }

        function calculateMonthlySummary(habits) {
            if (habits.length === 0) {
                return {
                    totalStudents: 0,
                    totalPoints: 0,
                    averagePoints: 0,
                    entriesPerDay: {}
                };
            }
            
            const uniqueStudents = [...new Set(habits.map(h => h.userId))];
            const totalPoints = habits.reduce((sum, h) => sum + (h.points || 0), 0);
            
            // Calculate entries per day
            const entriesPerDay = {};
            habits.forEach(habit => {
                entriesPerDay[habit.date] = (entriesPerDay[habit.date] || 0) + 1;
            });
            
            return {
                totalStudents: uniqueStudents.length,
                totalPoints: totalPoints,
                averagePoints: (totalPoints / habits.length).toFixed(1),
                entriesPerDay: entriesPerDay
            };
        }

        function calculateClassReportSummary(habits, students) {
            if (habits.length === 0) {
                return {
                    averagePointsPerStudent: 0,
                    completionRate: 0,
                    topPerformer: null
                };
            }
            
            // Calculate points per student
            const pointsPerStudent = {};
            habits.forEach(habit => {
                pointsPerStudent[habit.userId] = (pointsPerStudent[habit.userId] || 0) + (habit.points || 0);
            });
            
            // Find top performer
            let topPerformer = null;
            let maxPoints = 0;
            
            for (const [userId, points] of Object.entries(pointsPerStudent)) {
                if (points > maxPoints) {
                    maxPoints = points;
                    topPerformer = students.find(s => s.id === userId);
                }
            }
            
            const averagePointsPerStudent = (habits.reduce((sum, h) => sum + (h.points || 0), 0) / students.length).toFixed(1);
            const completionRate = Math.round((habits.length / (students.length * 30)) * 100);
            
            return {
                averagePointsPerStudent: averagePointsPerStudent,
                completionRate: Math.min(completionRate, 100),
                topPerformer: topPerformer ? {
                    name: topPerformer.nama,
                    points: maxPoints
                } : null
            };
        }

        function calculateStudentReportSummary(habits) {
            if (habits.length === 0) {
                return {
                    totalDays: 0,
                    totalPoints: 0,
                    averagePoints: 0,
                    consistencyScore: 0
                };
            }
            
            const totalDays = habits.length;
            const totalPoints = habits.reduce((sum, h) => sum + (h.points || 0), 0);
            const averagePoints = (totalPoints / totalDays).toFixed(1);
            
            // Calculate consistency (how many days in a row)
            let maxConsistency = 0;
            let currentConsistency = 0;
            let lastDate = null;
            
            // Sort by date ascending
            const sortedHabits = [...habits].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sortedHabits.forEach((habit, index) => {
                const currentDate = new Date(habit.date);
                
                if (lastDate) {
                    const diffDays = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) {
                        currentConsistency++;
                    } else {
                        currentConsistency = 1;
                    }
                } else {
                    currentConsistency = 1;
                }
                
                maxConsistency = Math.max(maxConsistency, currentConsistency);
                lastDate = currentDate;
            });
            
            const consistencyScore = Math.round((maxConsistency / 30) * 100);
            
            return {
                totalDays: totalDays,
                totalPoints: totalPoints,
                averagePoints: averagePoints,
                consistencyScore: consistencyScore
            };
        }

       function calculateStudentReportSummary(habits) {
    if (habits.length === 0) {
        return {
            totalDays: 0,
            totalPoints: 0,
            averagePoints: 0,
            consistencyScore: 0
        };
    }
    
    const totalDays = habits.length;
    const totalPoints = habits.reduce((sum, h) => sum + (h.points || 0), 0);
    const averagePoints = (totalPoints / totalDays).toFixed(1);
    
    // Calculate consistency (how many days in a row)
    let maxConsistency = 0;
    let currentConsistency = 0;
    let lastDate = null;
    
    // Sort by date ascending
    const sortedHabits = [...habits].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    sortedHabits.forEach((habit, index) => {
        const currentDate = new Date(habit.date);
        
        if (lastDate) {
            const diffDays = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
            if (diffDays === 1) {
                currentConsistency++;
            } else {
                currentConsistency = 1;
            }
        } else {
            currentConsistency = 1;
        }
        
        maxConsistency = Math.max(maxConsistency, currentConsistency);
        lastDate = currentDate;
    });
    
    const consistencyScore = Math.round((maxConsistency / 30) * 100);
    
    return {
        totalDays: totalDays,
        totalPoints: totalPoints,
        averagePoints: averagePoints,
        consistencyScore: consistencyScore
    };
}

// ==============================================
// CHART FUNCTIONS FOR REPORTING
// ==============================================

function createReportCharts(reportData) {
    // Destroy existing charts
    const charts = ['reportChart1', 'reportChart2'];
    charts.forEach(chartId => {
        const chart = Chart.getChart(chartId);
        if (chart) chart.destroy();
    });
    
    switch(reportData.type) {
        case 'daily':
        case 'monthly':
            createHabitsDistributionChart(reportData);
            createPointsTrendChart(reportData);
            break;
        case 'class':
            createClassPerformanceChart(reportData);
            createHabitsAverageChart(reportData);
            break;
        case 'student':
            createStudentProgressChart(reportData);
            createStudentHabitsChart(reportData);
            break;
    }
}

function createHabitsDistributionChart(reportData) {
    const ctx = document.getElementById('reportChart1');
    if (!ctx) return;
    
    // Calculate habit distribution
    const habitCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
    
    reportData.habits.forEach(habit => {
        const scores = habit.habits || {};
        for (let i = 1; i <= 7; i++) {
            const score = scores[`habit${i}`] || 0;
            if (score > 0) {
                habitCounts[i]++;
            }
        }
    });
    
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Habit 1', 'Habit 2', 'Habit 3', 'Habit 4', 'Habit 5', 'Habit 6', 'Habit 7'],
            datasets: [{
                label: 'Jumlah Pengisian',
                data: Object.values(habitCounts),
                backgroundColor: '#2196F3',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribusi Pengisian Kebiasaan'
                }
            }
        }
    });
}

function createPointsTrendChart(reportData) {
    const ctx = document.getElementById('reportChart2');
    if (!ctx) return;
    
    // Group by date
    const pointsByDate = {};
    reportData.habits.forEach(habit => {
        const date = habit.date;
        if (!pointsByDate[date]) {
            pointsByDate[date] = { total: 0, count: 0 };
        }
        pointsByDate[date].total += habit.points || 0;
        pointsByDate[date].count++;
    });
    
    // Sort dates
    const sortedDates = Object.keys(pointsByDate).sort();
    const averagePoints = sortedDates.map(date => 
        (pointsByDate[date].total / pointsByDate[date].count).toFixed(1)
    );
    
    new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: sortedDates.map(date => new Date(date).toLocaleDateString('id-ID')),
            datasets: [{
                label: 'Rata-rata Poin',
                data: averagePoints,
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Trend Poin Harian'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 21, // 7 habits * 3 points
                    title: {
                        display: true,
                        text: 'Rata-rata Poin'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tanggal'
                    }
                }
            }
        }
    });
}

function createClassPerformanceChart(reportData) {
    const ctx = document.getElementById('reportChart1');
    if (!ctx) return;
    
    if (!reportData.students || reportData.students.length === 0) return;
    
    // Calculate average points per student
    const studentPoints = reportData.students.map(student => {
        const studentHabits = reportData.habits.filter(h => h.userId === student.id);
        const totalPoints = studentHabits.reduce((sum, h) => sum + (h.points || 0), 0);
        const averagePoints = studentHabits.length > 0 ? (totalPoints / studentHabits.length).toFixed(1) : 0;
        return {
            name: student.nama,
            averagePoints: parseFloat(averagePoints)
        };
    });
    
    // Sort by average points (descending) and take top 10
    studentPoints.sort((a, b) => b.averagePoints - a.averagePoints);
    const topStudents = studentPoints.slice(0, 10);
    
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: topStudents.map(s => s.name.substring(0, 15) + (s.name.length > 15 ? '...' : '')),
            datasets: [{
                label: 'Rata-rata Poin',
                data: topStudents.map(s => s.averagePoints),
                backgroundColor: topStudents.map((_, i) => {
                    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
                    return colors[i % colors.length];
                }),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Top 10 Siswa Berdasarkan Rata-rata Poin'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 21,
                    title: {
                        display: true,
                        text: 'Rata-rata Poin'
                    }
                }
            }
        }
    });
}

function createHabitsAverageChart(reportData) {
    const ctx = document.getElementById('reportChart2');
    if (!ctx) return;
    
    // Calculate average for each habit
    const habitAverages = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
    const habitCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
    
    reportData.habits.forEach(habit => {
        const scores = habit.habits || {};
        for (let i = 1; i <= 7; i++) {
            const score = scores[`habit${i}`] || 0;
            if (score > 0) {
                habitAverages[i] += score;
                habitCounts[i]++;
            }
        }
    });
    
    // Calculate final averages
    const finalAverages = [];
    for (let i = 1; i <= 7; i++) {
        finalAverages.push(habitCounts[i] > 0 ? (habitAverages[i] / habitCounts[i]).toFixed(1) : 0);
    }
    
    // Determine colors based on score
    const backgroundColors = finalAverages.map(avg => {
        const score = parseFloat(avg);
        if (score >= 2.5) return '#4CAF50'; // Excellent
        if (score >= 1.5) return '#FF9800'; // Good
        return '#f44336'; // Poor
    });
    
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Habit 1', 'Habit 2', 'Habit 3', 'Habit 4', 'Habit 5', 'Habit 6', 'Habit 7'],
            datasets: [{
                label: 'Rata-rata Skor',
                data: finalAverages,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Rata-rata Skor Per Kebiasaan'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 3,
                    title: {
                        display: true,
                        text: 'Skor Rata-rata'
                    }
                }
            }
        }
    });
}

function createStudentProgressChart(reportData) {
    const ctx = document.getElementById('reportChart1');
    if (!ctx) return;
    
    if (!reportData.habits || reportData.habits.length === 0) return;
    
    // Sort habits by date
    const sortedHabits = [...reportData.habits].sort((a, b) => 
        new Date(a.date) - new Date(b.date)
    );
    
    const dates = sortedHabits.map(h => 
        new Date(h.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })
    );
    const points = sortedHabits.map(h => h.points || 0);
    
    // Calculate moving average (3-day)
    const movingAverages = [];
    for (let i = 0; i < points.length; i++) {
        let sum = 0;
        let count = 0;
        for (let j = Math.max(0, i - 2); j <= i; j++) {
            sum += points[j];
            count++;
        }
        movingAverages.push((sum / count).toFixed(1));
    }
    
    new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Poin Harian',
                    data: points,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Rata-rata Bergerak (3 hari)',
                    data: movingAverages,
                    borderColor: '#FF9800',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Progress Poin Harian'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 21,
                    title: {
                        display: true,
                        text: 'Total Poin'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tanggal'
                    }
                }
            }
        }
    });
}

function createStudentHabitsChart(reportData) {
    const ctx = document.getElementById('reportChart2');
    if (!ctx) return;
    
    if (!reportData.habits || reportData.habits.length === 0) return;
    
    // Calculate average for each habit
    const habitTotals = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
    const habitCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
    
    reportData.habits.forEach(habit => {
        const scores = habit.habits || {};
        for (let i = 1; i <= 7; i++) {
            const score = scores[`habit${i}`] || 0;
            if (score > 0) {
                habitTotals[i] += score;
                habitCounts[i]++;
            }
        }
    });
    
    const habitAverages = [];
    const completionRates = [];
    for (let i = 1; i <= 7; i++) {
        habitAverages.push(habitCounts[i] > 0 ? (habitTotals[i] / habitCounts[i]).toFixed(1) : 0);
        completionRates.push((habitCounts[i] / reportData.habits.length * 100).toFixed(0));
    }
    
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Habit 1', 'Habit 2', 'Habit 3', 'Habit 4', 'Habit 5', 'Habit 6', 'Habit 7'],
            datasets: [
                {
                    label: 'Rata-rata Skor',
                    data: habitAverages,
                    backgroundColor: 'rgba(33, 150, 243, 0.7)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'Completion Rate (%)',
                    data: completionRates,
                    backgroundColor: 'rgba(255, 152, 0, 0.7)',
                    borderWidth: 1,
                    yAxisID: 'y1',
                    type: 'line'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Analisis Kebiasaan Siswa'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    max: 3,
                    title: {
                        display: true,
                        text: 'Rata-rata Skor'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Completion Rate (%)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// ==============================================
// CSV EXPORT FUNCTIONS
// ==============================================

function exportHabitsToCSV(habits) {
    let csv = 'Nama,Kelas,Tanggal,Total Poin,Habit 1,Habit 2,Habit 3,Habit 4,Habit 5,Habit 6,Habit 7\n';
    
    habits.forEach(habit => {
        const scores = habit.habits || {};
        csv += `"${habit.userName}","${habit.class || ''}","${habit.date}",${habit.points || 0},`;
        csv += `${scores.habit1 || 0},${scores.habit2 || 0},${scores.habit3 || 0},`;
        csv += `${scores.habit4 || 0},${scores.habit5 || 0},${scores.habit6 || 0},`;
        csv += `${scores.habit7 || 0}\n`;
    });
    
    return csv;
}

function exportClassReportToCSV(reportData) {
    let csv = 'Laporan Kelas: ' + reportData.kelas + '\n';
    csv += 'Periode: ' + reportData.startDate + ' sampai ' + reportData.endDate + '\n';
    csv += 'Total Siswa: ' + reportData.totalStudents + '\n';
    csv += 'Total Entries: ' + reportData.totalEntries + '\n\n';
    
    csv += 'Nama Siswa,Total Hari,Total Poin,Rata-rata/Hari,Completion Rate (%),Kelas\n';
    
    // Calculate statistics for each student
    const studentStats = reportData.students.map(student => {
        const studentHabits = reportData.habits.filter(h => h.userId === student.id);
        const totalDays = studentHabits.length;
        const totalPoints = studentHabits.reduce((sum, h) => sum + (h.points || 0), 0);
        const averagePoints = totalDays > 0 ? (totalPoints / totalDays).toFixed(1) : 0;
        const completionRate = Math.round((totalDays / 30) * 100);
        
        return {
            name: student.nama,
            totalDays,
            totalPoints,
            averagePoints,
            completionRate,
            kelas: student.kelas || '-'
        };
    });
    
    // Sort by total points (descending)
    studentStats.sort((a, b) => b.totalPoints - a.totalPoints);
    
    studentStats.forEach(student => {
        csv += `"${student.name}",${student.totalDays},${student.totalPoints},${student.averagePoints},${student.completionRate},"${student.kelas}"\n`;
    });
    
    // Add summary
    csv += '\nSummary\n';
    csv += 'Rata-rata Poin/Kelas,' + (reportData.habits.length > 0 ? 
        (reportData.habits.reduce((sum, h) => sum + (h.points || 0), 0) / reportData.habits.length).toFixed(1) : 0) + '\n';
    csv += 'Entries per Siswa,' + Math.round(reportData.totalEntries / reportData.totalStudents) + '\n';
    
    return csv;
}

function exportStudentReportToCSV(reportData) {
    let csv = 'Laporan Siswa: ' + reportData.student.nama + '\n';
    csv += 'Kelas: ' + (reportData.student.kelas || '-') + '\n';
    csv += 'Periode: ' + reportData.dateRange + '\n';
    csv += 'Total Hari: ' + reportData.habits.length + '\n';
    csv += 'Total Poin: ' + reportData.habits.reduce((sum, h) => sum + (h.points || 0), 0) + '\n\n';
    
    csv += 'Tanggal,Total Poin,Habit 1,Habit 2,Habit 3,Habit 4,Habit 5,Habit 6,Habit 7\n';
    
    // Sort by date descending
    const sortedHabits = [...reportData.habits].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedHabits.forEach(habit => {
        const scores = habit.habits || {};
        csv += `${habit.date},${habit.points || 0},`;
        csv += `${scores.habit1 || 0},${scores.habit2 || 0},${scores.habit3 || 0},`;
        csv += `${scores.habit4 || 0},${scores.habit5 || 0},${scores.habit6 || 0},`;
        csv += `${scores.habit7 || 0}\n`;
    });
    
    // Add habit averages
    csv += '\nRata-rata Kebiasaan\n';
    const habitAverages = {};
    for (let i = 1; i <= 7; i++) {
        const total = reportData.habits.reduce((sum, h) => sum + ((h.habits || {})[`habit${i}`] || 0), 0);
        habitAverages[`habit${i}`] = (total / reportData.habits.length).toFixed(1);
    }
    
    csv += 'Habit 1,' + habitAverages.habit1 + '\n';
    csv += 'Habit 2,' + habitAverages.habit2 + '\n';
    csv += 'Habit 3,' + habitAverages.habit3 + '\n';
    csv += 'Habit 4,' + habitAverages.habit4 + '\n';
    csv += 'Habit 5,' + habitAverages.habit5 + '\n';
    csv += 'Habit 6,' + habitAverages.habit6 + '\n';
    csv += 'Habit 7,' + habitAverages.habit7 + '\n';
    
    return csv;
}

// ==============================================
// REPORT UI FUNCTIONS
// ==============================================

function cancelReport() {
    document.getElementById('reportFilters').style.display = 'none';
    document.getElementById('reportResults').style.display = 'none';
}

function printReport() {
    window.print();
}

function downloadReport() {
    alert('Fitur download PDF akan tersedia di versi mendatang.');
}

function exportReportToExcel() {
    if (!currentReportData) {
        alert('‚ö†Ô∏è Tidak ada data laporan untuk di-export!');
        return;
    }
    
    try {
        let csvContent = '';
        
        switch(currentReportData.type) {
            case 'daily':
            case 'monthly':
                csvContent = exportHabitsToCSV(currentReportData.habits);
                break;
            case 'class':
                csvContent = exportClassReportToCSV(currentReportData);
                break;
            case 'student':
                csvContent = exportStudentReportToCSV(currentReportData);
                break;
        }
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const dateStr = new Date().toISOString().split('T')[0];
        const fileName = `report_${currentReportData.type}_${dateStr}.csv`;
        
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`‚úÖ Laporan berhasil diexport!`);
        
    } catch (error) {
        alert('‚ùå Gagal export laporan: ' + error.message);
    }
}

// ==============================================
// MAIN INITIALIZATION (lanjutan)
// ==============================================

// ... (sisa kode tetap seperti semula sampai akhir file)

        // ==============================================
        // MAIN INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("üëë Admin Dashboard Loading...");
            
            // 1. CHECK LOGIN
            if (!isLoggedIn()) {
                alert('‚ö†Ô∏è Silakan login terlebih dahulu!');
                window.location.href = 'login.html';
                return;
            }
            
            // 2. CHECK ADMIN ROLE
            const user = getCurrentUser();
            console.log("Current user:", user);
            
            if (user.role !== 'admin') {
                alert('‚ùå Hanya admin yang bisa mengakses halaman ini!');
                logout();
                return;
            }
            
            // 3. DISPLAY ADMIN NAME
            document.getElementById('adminName').textContent = `Halo, ${user.nama}`;
            
            // 4. LOAD CLASSES FIRST
            console.log("üîÑ Memuat kelas terlebih dahulu...");
            await loadClasses();
            
            // 5. LOAD OTHER DATA
            await loadInitialData();
            
            // 6. SETUP EVENT LISTENERS
            setupEventListeners();
            
            // 7. START SYSTEM UPDATES
            startSystemUpdates();
            
            console.log("‚úÖ Admin Dashboard Ready!");
            
            // Debug: cek dropdown setelah load
            setTimeout(() => {
                debugClasses();
            }, 1000);
        });

        async function loadInitialData() {
            try {
                // Load users
                await loadAllUsers();
                
                // Load statistics
                await loadStatistics();
                
                // Load recent activity
                await loadRecentActivity();
                
                // Update system info
                updateSystemInfo();
                
                // Load quick stats
                await loadQuickStats();
                
            } catch (error) {
                console.error("Initial data load error:", error);
                alert('‚ö†Ô∏è Gagal memuat data awal: ' + error.message);
            }
        }

        // ==============================================
        // OTHER NECESSARY FUNCTIONS
        // ==============================================

        async function loadAllUsers() {
            try {
                console.log("üìã Loading all users...");
                const snapshot = await db.collection('users').get();
                allUsers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Normalize class names for all users
                allUsers.forEach(user => {
                    if (user.kelas) {
                        user.kelas = normalizeClassName(user.kelas);
                    }
                });
                
                // Sort by creation date (newest first)
                allUsers.sort((a, b) => {
                    return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                });
                
                filteredUsers = [...allUsers];
                displayUsers();
                updatePagination();
                
                console.log(`‚úÖ Loaded ${allUsers.length} users`);
                
            } catch (error) {
                console.error("‚ùå Error loading users:", error);
                document.getElementById('usersList').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #f44336; padding: 30px;">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Gagal memuat data pengguna: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function normalizeClassName(className) {
            if (!className) return '';
            
            let normalized = className.trim();
            
            if (normalized.toLowerCase().startsWith('kelas')) {
                normalized = 'Kelas' + normalized.substring(5);
            }
            
            if (!normalized.startsWith('Kelas')) {
                normalized = 'Kelas ' + normalized;
            }
            
            return normalized;
        }

        function displayUsers() {
            const tbody = document.getElementById('usersList');
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = filteredUsers.slice(startIndex, endIndex);
            
            if (pageUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-users-slash"></i><br>
                            Tidak ada pengguna yang ditemukan
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            pageUsers.forEach((user, index) => {
                const globalIndex = startIndex + index + 1;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td>
                        <strong>${user.nama}</strong>
                        ${user.email ? `<br><small style="color: #666;">${user.email}</small>` : ''}
                    </td>
                    <td>${user.kelas || '-'}</td>
                    <td>
                        <span class="role-badge ${user.role}">
                            ${user.role === 'admin' ? 'ADMIN' : 'USER'}
                        </span>
                    </td>
                    <td>
                        ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('id-ID') : '-'}
                        ${user.imported ? '<br><small style="color: #666;">(imported)</small>' : ''}
                    </td>
                    <td>
                        <button onclick="viewUserProgress('${user.id}', '${user.nama}')" 
                                class="btn-primary" style="padding: 5px 10px;">
                            <i class="fas fa-eye"></i> Lihat
                        </button>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editUser('${user.id}', '${user.nama}')" 
                                    class="btn-primary" style="padding: 5px 10px;" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            
                            ${user.nama !== 'admin' ? 
                                `<button onclick="deleteUserById('${user.id}', '${user.nama}')" 
                                        class="btn-delete" style="padding: 5px 10px;" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>` 
                                : ''
                            }
                            
                            ${user.role === 'user' ? 
                                `<button onclick="makeAdmin('${user.id}', '${user.nama}')" 
                                        class="btn-admin" style="padding: 5px 10px;" title="Jadikan Admin">
                                    <i class="fas fa-user-shield"></i>
                                </button>` 
                                : ''
                            }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update counts
            document.getElementById('currentCount').textContent = pageUsers.length;
            document.getElementById('totalCount').textContent = filteredUsers.length;
            document.getElementById('currentPage').textContent = currentPage;
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const kelasFilter = document.getElementById('filterKelas').value;
            
            filteredUsers = allUsers.filter(user => {
                const nameMatch = user.nama.toLowerCase().includes(searchTerm);
                const roleMatch = !roleFilter || user.role === roleFilter;
                
                const userKelasNormalized = user.kelas ? normalizeClassName(user.kelas) : '';
                const filterKelasNormalized = kelasFilter ? normalizeClassName(kelasFilter) : '';
                
                const kelasMatch = !kelasFilter || userKelasNormalized === filterKelasNormalized;
                
                return nameMatch && roleMatch && kelasMatch;
            });
            
            currentPage = 1;
            displayUsers();
            updatePagination();
        }

        function resetSearch() {
            document.getElementById('searchUser').value = '';
            document.getElementById('filterRole').value = '';
            document.getElementById('filterKelas').value = '';
            filteredUsers = [...allUsers];
            currentPage = 1;
            displayUsers();
            updatePagination();
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayUsers();
                updatePagination();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayUsers();
                updatePagination();
            }
        }

        async function editUser(userId, userName) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const newName = prompt(`Edit nama untuk ${userName}:`, userName);
            if (newName && newName.trim() && newName !== userName) {
                try {
                    await db.collection('users').doc(userId).update({
                        nama: newName.trim(),
                        updatedAt: new Date().toISOString()
                    });
                    
                    alert('‚úÖ Nama berhasil diubah!');
                    await loadAllUsers();
                    
                } catch (error) {
                    alert('‚ùå Gagal mengubah nama: ' + error.message);
                }
            }
        }

        async function deleteUserById(userId, userName) {
            if (!confirm(`Hapus user "${userName}"?\n\nSEMUA data kebiasaan user ini juga akan dihapus!`)) {
                return;
            }
            
            try {
                // Delete user
                await db.collection('users').doc(userId).delete();
                
                // Delete user's habits
                const habitsSnapshot = await db.collection('habits')
                    .where('userId', '==', userId)
                    .get();
                
                const batch = db.batch();
                habitsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                if (habitsSnapshot.size > 0) {
                    await batch.commit();
                }
                
                alert(`‚úÖ User "${userName}" dan ${habitsSnapshot.size} data kebiasaan berhasil dihapus!`);
                await loadAllUsers();
                
            } catch (error) {
                alert('‚ùå Gagal menghapus user: ' + error.message);
            }
        }

        async function makeAdmin(userId, userName) {
            if (!confirm(`Jadikan "${userName}" sebagai Admin?\n\nUser akan bisa login dengan password.`)) {
                return;
            }
            
            const password = prompt('Masukkan password untuk admin baru:', 'admin123');
            if (!password) {
                alert('‚ùå Password diperlukan untuk admin!');
                return;
            }
            
            try {
                await db.collection('users').doc(userId).update({
                    role: 'admin',
                    password: password,
                    kelas: null,
                    updatedAt: new Date().toISOString(),
                    promotedBy: getCurrentUser().nama
                });
                
                alert(`‚úÖ "${userName}" sekarang menjadi Admin!`);
                await loadAllUsers();
                
            } catch (error) {
                alert('‚ùå Gagal mengubah role: ' + error.message);
            }
        }

        async function viewUserProgress(userId, userName) {
            alert(`Progress untuk ${userName}\n\nFitur ini akan dikembangkan lebih lanjut.`);
        }

        // ==============================================
        // ADD USER FUNCTIONS
        // ==============================================

        function toggleKelasField() {
            const role = document.getElementById('userRole').value;
            const kelasField = document.getElementById('kelasField');
            const kelasSelect = document.getElementById('userKelas');
            
            if (role === 'admin') {
                kelasField.style.display = 'none';
                kelasSelect.removeAttribute('required');
                document.getElementById('passwordField').style.display = 'block';
            } else {
                kelasField.style.display = 'block';
                kelasSelect.setAttribute('required', 'required');
                document.getElementById('passwordField').style.display = 'none';
            }
        }

        async function addUser() {
            const nama = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('userRole').value;
            const kelas = role === 'user' ? document.getElementById('userKelas').value : null;
            const password = document.getElementById('userPassword').value;
            const email = document.getElementById('userEmail').value.trim();
            
            // Validasi
            if (!nama) {
                alert('‚ö†Ô∏è Nama tidak boleh kosong!');
                return;
            }
            
            if (nama.length < 3) {
                alert('‚ö†Ô∏è Nama minimal 3 karakter!');
                return;
            }
            
            if (role === 'user' && !kelas) {
                alert('‚ö†Ô∏è Pilih kelas untuk user!');
                return;
            }
            
            if (role === 'admin' && !password) {
                alert('‚ö†Ô∏è Password diperlukan untuk admin!');
                return;
            }
            
            try {
                // Check if user already exists
                const checkSnapshot = await db.collection('users')
                    .where('nama', '==', nama)
                    .limit(1)
                    .get();
                
                if (!checkSnapshot.empty) {
                    alert('‚ùå User dengan nama tersebut sudah ada!');
                    return;
                }
                
                // Prepare user data
                const userData = {
                    nama: nama,
                    role: role,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: getCurrentUser().nama
                };
                
                if (role === 'user' && kelas) {
                    userData.kelas = normalizeClassName(kelas);
                }
                
                if (email) userData.email = email;
                if (password) userData.password = password;
                
                // Add to database
                await db.collection('users').add(userData);
                
                alert(`‚úÖ User "${nama}" berhasil ditambahkan!`);
                
                // Reset form
                document.getElementById('addUserForm').reset();
                toggleKelasField();
                
                // Reload users and classes
                await loadAllUsers();
                await loadClasses();
                await loadStatistics();
                
            } catch (error) {
                alert('‚ùå Gagal menambahkan user: ' + error.message);
            }
        }

        async function addBulkUsers() {
            alert('Fitur tambah banyak user akan segera tersedia.');
        }

        // ==============================================
        // RECENT ACTIVITY FUNCTIONS
        // ==============================================

        async function loadRecentActivity() {
            try {
                const activityDiv = document.getElementById('recentActivity');
                
                // Get recent users (last 5)
                const recentUsers = allUsers.slice(0, 5);
                
                // Get recent habits (if available)
                let recentHabits = [];
                if (typeof db !== 'undefined') {
                    const snapshot = await db.collection('habits')
                        .orderBy('completedAt', 'desc')
                        .limit(5)
                        .get();
                    
                    recentHabits = snapshot.docs.map(doc => doc.data());
                }
                
                // Display activity
                let html = '<div style="display: grid; gap: 10px;">';
                
                // Add user registrations
                recentUsers.forEach(user => {
                    const date = new Date(user.createdAt).toLocaleDateString('id-ID');
                    html += `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="color: #4CAF50;">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div style="flex: 1;">
                                <strong>${user.nama}</strong> mendaftar sebagai ${user.role}
                                ${user.kelas ? `(${user.kelas})` : ''}
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${date}
                            </div>
                        </div>
                    `;
                });
                
                // Add habit activities
                recentHabits.forEach(habit => {
                    const date = new Date(habit.completedAt).toLocaleDateString('id-ID');
                    html += `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="color: #2196F3;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div style="flex: 1;">
                                <strong>${habit.userName}</strong> mengisi tracker kebiasaan
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${date}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                activityDiv.innerHTML = html;
                
            } catch (error) {
                console.error("Recent activity error:", error);
            }
        }

        // ==============================================
        // QUICK STATS FUNCTIONS
        // ==============================================

        async function loadQuickStats() {
            try {
                // Today's active users
                const today = new Date().toISOString().split('T')[0];
                const todaySnapshot = await db.collection('habits')
                    .where('date', '==', today)
                    .get();
                
                document.getElementById('todayActive').textContent = todaySnapshot.size;
                
                // Monthly average
                const monthAgo = new Date();
                monthAgo.setDate(monthAgo.getDate() - 30);
                
                const monthSnapshot = await db.collection('habits')
                    .where('date', '>=', monthAgo.toISOString().split('T')[0])
                    .get();
                
                const monthlyAvg = monthSnapshot.size > 0 ? (monthSnapshot.size / 30).toFixed(1) : 0;
                document.getElementById('monthlyAvg').textContent = monthlyAvg;
                
                // Total classes
                document.getElementById('totalClasses').textContent = classes.length;
                
                // Total points
                let totalPoints = 0;
                const habitsSnapshot = await db.collection('habits').get();
                habitsSnapshot.forEach(doc => {
                    totalPoints += doc.data().points || 0;
                });
                document.getElementById('totalPoints').textContent = totalPoints;
                
            } catch (error) {
                console.error("Quick stats error:", error);
            }
        }

        // ==============================================
        // CHART FUNCTIONS
        // ==============================================

        function updateUserChart(regularUsers, adminUsers) {
            const ctx = document.getElementById('userChart');
            if (!ctx) return;
            
            // Destroy existing chart if exists
            if (userChartInstance) {
                userChartInstance.destroy();
            }
            
            userChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Pengguna Biasa', 'Admin'],
                    datasets: [{
                        data: [regularUsers, adminUsers],
                        backgroundColor: ['#4CAF50', '#2196F3'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==============================================
        // SYSTEM FUNCTIONS
        // ==============================================

        function updateSystemInfo() {
            // Browser info
            document.getElementById('browserInfo').textContent = 
                navigator.userAgent.split(' ')[0];
            
            // Screen resolution
            document.getElementById('screenResolution').textContent = 
                `${window.screen.width} √ó ${window.screen.height}`;
            
            // Local storage
            const lsSize = JSON.stringify(localStorage).length;
            document.getElementById('localStorageStatus').textContent = 
                `${(lsSize / 1024).toFixed(2)} KB`;
            
            // Timezone
            document.getElementById('timezone').textContent = 
                Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Update time
            updateTime();
        }

        function updateTime() {
            const now = new Date();
            
            document.getElementById('serverTime').textContent = 
                now.toLocaleString('id-ID');
            
            document.getElementById('localTime').textContent = 
                now.toLocaleTimeString('id-ID');
            
            // Update uptime (simulated)
            const uptimeDiv = document.getElementById('uptime');
            if (window.startTime) {
                const uptime = Math.floor((now - window.startTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                uptimeDiv.textContent = `${hours}h ${minutes}m ${seconds}s`;
            } else {
                window.startTime = now;
                uptimeDiv.textContent = '0s';
            }
        }

        function startSystemUpdates() {
            window.startTime = new Date();
            
            // Update time every second
            setInterval(updateTime, 1000);
            
            // Update sync time every minute
            setInterval(() => {
                document.getElementById('lastSync').textContent = 
                    new Date().toLocaleTimeString('id-ID');
            }, 60000);
        }

        async function testDatabaseConnection() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                btn.disabled = true;
                
                // Test connection
                const testRef = await db.collection('test_connection').add({
                    test: 'connection_test',
                    timestamp: new Date().toISOString()
                });
                
                // Get collections count
                const collections = ['users', 'habits', 'classes'];
                let totalDocs = 0;
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    totalDocs += snapshot.size;
                }
                
                // Cleanup test
                await db.collection('test_connection').doc(testRef.id).delete();
                
                // Update UI
                document.getElementById('firebaseStatus').innerHTML = 
                    '<span style="color: #4CAF50;">‚úÖ Connected</span>';
                document.getElementById('collectionsCount').textContent = collections.length;
                document.getElementById('totalDocuments').textContent = totalDocs;
                
                alert('‚úÖ Database connection successful!');
                
            } catch (error) {
                document.getElementById('firebaseStatus').innerHTML = 
                    '<span style="color: #f44336;">‚ùå Disconnected</span>';
                alert('‚ùå Database connection failed: ' + error.message);
            } finally {
                event.target.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
                event.target.disabled = false;
            }
        }

        function clearAdminCache() {
            if (confirm('Clear semua cache admin?\n\nIni akan menghapus data sementara di browser.')) {
                // Clear only admin-related cache
                const keysToKeep = ['currentUser', 'auth_session', 'userNama', 'userRole', 'userId'];
                
                Object.keys(localStorage).forEach(key => {
                    if (!keysToKeep.includes(key) && !key.startsWith('habits_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                alert('‚úÖ Cache cleared!');
                location.reload();
            }
        }

        async function backupDatabase() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backing up...';
                btn.disabled = true;
                
                // Collect all data
                const backupData = {
                    timestamp: new Date().toISOString(),
                    admin: getCurrentUser().nama,
                    collections: {}
                };
                
                // Backup users
                const usersSnapshot = await db.collection('users').get();
                backupData.collections.users = usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Backup habits
                const habitsSnapshot = await db.collection('habits').get();
                backupData.collections.habits = habitsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Backup classes
                const classesSnapshot = await db.collection('classes').get();
                backupData.collections.classes = classesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Create download
                const blob = new Blob([JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const dateStr = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `backup_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Backup berhasil!\nUsers: ${usersSnapshot.size}\nHabits: ${habitsSnapshot.size}\nClasses: ${classesSnapshot.size}`);
                
            } catch (error) {
                alert('‚ùå Backup failed: ' + error.message);
            } finally {
                event.target.innerHTML = '<i class="fas fa-download"></i> Backup Database';
                event.target.disabled = false;
            }
        }

        function restoreDatabase() {
            alert('‚ö†Ô∏è Fitur restore akan tersedia di versi mendatang.\nGunakan Firebase Console untuk restore data.');
        }

        // ==============================================
        // DEBUG FUNCTIONS
        // ==============================================

        function debugClasses() {
            console.log("üîç DEBUG CLASSES:");
            console.log("Classes array length:", classes ? classes.length : 0);
            console.log("Classes:", classes);
            
            const classSelects = ['filterKelas', 'progressKelas', 'userKelas'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    console.log(`${selectId}:`, {
                        id: selectId,
                        exists: true,
                        options: select.options.length,
                        value: select.value,
                        innerHTML: select.innerHTML.substring(0, 100) + '...'
                    });
                } else {
                    console.error(`${selectId}: Element not found!`);
                }
            });
            
            // Show alert with summary
            const filterKelas = document.getElementById('filterKelas');
            const optionsCount = filterKelas ? filterKelas.options.length : 0;
            alert(`Debug Classes:\n- Classes in array: ${classes.length}\n- Options in dropdown: ${optionsCount}\n\nCheck console for details.`);
        }

        async function refreshClasses() {
            console.log("üîÑ Manually refreshing classes...");
            await loadClasses();
            alert('‚úÖ Classes refreshed! Check console for details.');
        }

        // ==============================================
        // SETUP EVENT LISTENERS
        // ==============================================
        function setupEventListeners() {
            // Add user form
            const addForm = document.getElementById('addUserForm');
            if (addForm) {
                // Initialize kelas field
                toggleKelasField();
                
                // Handle form submit
                addForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addUser();
                });
            }
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    document.querySelectorAll('.sidebar-menu a').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const targetId = this.getAttribute('href').substring(1);
                    document.querySelectorAll('.admin-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        
                        // Refresh data for specific sections
                        if (targetId === 'users') {
                            await loadAllUsers();
                        } else if (targetId === 'progress') {
                            await loadProgressData();
                        } else if (targetId === 'stats') {
                            await loadStatistics();
                        } else if (targetId === 'system') {
                            updateSystemInfo();
                        } else if (targetId === 'addUser') {
                            toggleKelasField();
                        } else if (targetId === 'reporting') {
                            // Reset report view
                            cancelReport();
                        }
                    }
                });
            });
            
            // File upload handling
            const fileInput = document.getElementById('excelFile');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
                    document.querySelector('#dropZone p').textContent = `File: ${fileName}`;
                });
            }
        }

        // ==============================================
        // EXPOSE FUNCTIONS TO WINDOW
        // ==============================================
        window.searchUsers = searchUsers;
        window.resetSearch = resetSearch;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.editUser = editUser;
        window.deleteUserById = deleteUserById;
        window.makeAdmin = makeAdmin;
        window.addUser = addUser;
        window.addBulkUsers = addBulkUsers;
        window.toggleKelasField = toggleKelasField;
        window.debugClasses = debugClasses;
        window.refreshClasses = refreshClasses;
        window.loadProgressData = loadProgressData;
        window.resetProgressFilters = resetProgressFilters;
        window.exportProgressToExcel = exportProgressToExcel;
        window.generateDailyReport = generateDailyReport;
        window.generateMonthlyReport = generateMonthlyReport;
        window.generateClassReport = generateClassReport;
        window.generateStudentReport = generateStudentReport;
        window.generateHabitsReport = generateHabitsReport;
        window.generateReport = generateReport;
        window.cancelReport = cancelReport;
        window.printReport = printReport;
        window.downloadReport = downloadReport;
        window.exportReportToExcel = exportReportToExcel;

        // IMPORTANT: Add fallback function in case classes don't load
        setTimeout(() => {
            const filterKelas = document.getElementById('filterKelas');
            if (filterKelas && filterKelas.options.length <= 1) {
                console.log("‚ö†Ô∏è Dropdown kelas kosong, memuat ulang...");
                loadClasses();
            }
        }, 3000);

        console.log("üõ†Ô∏è Admin functions ready!");
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
            <div class="nav-links">
                <span id="adminName"></span>
                <button onclick="customAuth.logout()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-menu">
                <a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#users"><i class="fas fa-users"></i> Kelola Pengguna</a>
                <a href="#addUser"><i class="fas fa-user-plus"></i> Tambah Pengguna</a>
                <a href="#stats"><i class="fas fa-chart-bar"></i> Statistik</a>
            </div>
        </aside>

        <main class="admin-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="admin-section">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Admin</h2>
                <div class="admin-stats">
                    <div class="admin-stat-card">
                        <h3 id="totalUsersAdmin">0</h3>
                        <p>Total Pengguna</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="adminUsers">0</h3>
                        <p>Admin</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="regularUsers">0</h3>
                        <p>Pengguna Biasa</p>
                    </div>
                </div>
            </section>

            <!-- Manage Users Section -->
            <section id="users" class="admin-section" style="display: none;">
                <h2><i class="fas fa-users"></i> Kelola Pengguna</h2>
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Role</th>
                                <th>Tanggal Daftar</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Add User Section -->
            <section id="addUser" class="admin-section" style="display: none;">
                <h2><i class="fas fa-user-plus"></i> Tambah Pengguna Baru</h2>
                <div class="add-user-form">
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newUserName">Nama Pengguna</label>
                            <input type="text" id="newUserName" placeholder="Masukkan nama lengkap" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole" required>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus"></i> Tambah Pengguna
                        </button>
                    </form>
                </div>
            </section>

            <!-- Statistics Section -->
            <section id="stats" class="admin-section" style="display: none;">
                <h2><i class="fas fa-chart-bar"></i> Statistik</h2>
                <div class="charts-container">
                    <div class="chart-box">
                        <h3>Distribusi Pengguna</h3>
                        <canvas id="userChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!customAuth.isLoggedIn() || customAuth.getCurrentUser().role !== 'admin') {
                window.location.href = 'login.html';
                return;
            }

            // Display admin name
            const user = customAuth.getCurrentUser();
            document.getElementById('adminName').textContent = `Halo, ${user.nama}`;

            // Load statistics
            await loadStats();
            await loadUsers();

            // Sidebar navigation
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active link
                    document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const target = this.getAttribute('href').substring(1);
                    document.querySelectorAll('.admin-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    document.getElementById(target).style.display = 'block';
                });
            });

            // Add user form
            document.getElementById('addUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('newUserName').value.trim();
                const role = document.getElementById('userRole').value;
                
                const result = await customAuth.registerUser(name, role);
                
                if (result.success) {
                    alert('Pengguna berhasil ditambahkan!');
                    document.getElementById('addUserForm').reset();
                    await loadStats();
                    await loadUsers();
                } else {
                    alert('Error: ' + result.message);
                }
            });
        });

        async function loadStats() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const totalUsers = usersSnapshot.size;
                let adminCount = 0;
                
                usersSnapshot.forEach(doc => {
                    if (doc.data().role === 'admin') {
                        adminCount++;
                    }
                });
                
                document.getElementById('totalUsersAdmin').textContent = totalUsers;
                document.getElementById('adminUsers').textContent = adminCount;
                document.getElementById('regularUsers').textContent = totalUsers - adminCount;
                
                // Update chart if on stats page
                if (document.getElementById('userChart')) {
                    updateChart(totalUsers - adminCount, adminCount);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const tbody = document.getElementById('usersList');
                tbody.innerHTML = '';
                
                let index = 1;
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${index++}</td>
                        <td>${user.nama}</td>
                        <td><span class="role-badge ${user.role}">${user.role}</span></td>
                        <td>${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString('id-ID') : '-'}</td>
                        <td>
                            <button onclick="deleteUser('${doc.id}')" class="btn-delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function deleteUser(userId) {
            if (confirm('Apakah Anda yakin ingin menghapus pengguna ini?')) {
                try {
                    await db.collection('users').doc(userId).delete();
                    alert('Pengguna berhasil dihapus!');
                    await loadStats();
                    await loadUsers();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        function updateChart(regularUsers, adminUsers) {
            const ctx = document.getElementById('userChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pengguna Biasa', 'Admin'],
                    datasets: [{
                        data: [regularUsers, adminUsers],
                        backgroundColor: ['#4CAF50', '#2196F3']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
    </script>
</body>
</html>

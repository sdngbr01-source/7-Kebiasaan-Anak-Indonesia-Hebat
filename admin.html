<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - 7 Kebiasaan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    <style>
        /* Additional Admin Styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-badge.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-badge.updated {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .import-box {
            border: 2px dashed #ccc;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            background: #f9f9f9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            margin: 10px 0;
            color: #2196F3;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .action-btn {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
            transform: translateY(-2px);
        }
        
        .import-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .progress-bar-small {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .progress-fill-small {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .completion-excellent { background: #4CAF50; }
        .completion-good { background: #FF9800; }
        .completion-poor { background: #2196F3; }
        .completion-none { background: #f44336; }
        
        @media (max-width: 768px) {
            .import-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
            <div class="nav-links">
                <span id="adminName">Loading...</span>
                <button onclick="logout()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-menu">
                <a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#users"><i class="fas fa-users"></i> Kelola Pengguna</a>
                <a href="#addUser"><i class="fas fa-user-plus"></i> Tambah Pengguna</a>
                <a href="#importExcel"><i class="fas fa-file-import"></i> Import dari Excel</a>
                <a href="#progress"><i class="fas fa-chart-line"></i> Progress Tracking</a>
                <a href="#reporting"><i class="fas fa-file-alt"></i> Reporting</a>
                <a href="#stats"><i class="fas fa-chart-bar"></i> Statistik</a>
                <a href="#system"><i class="fas fa-cog"></i> System Info</a>
            </div>
        </aside>

        <main class="admin-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="admin-section">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Admin</h2>
                
                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="admin-stat-card">
                        <h3 id="totalUsersAdmin">0</h3>
                        <p>Total Pengguna</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="adminUsers">0</h3>
                        <p>Admin</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="regularUsers">0</h3>
                        <p>Pengguna Biasa</p>
                    </div>
                    <div class="admin-stat-card">
                        <h3 id="totalHabits">0</h3>
                        <p>Data Kebiasaan</p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#addUser\\']').click()">
                        <i class="fas fa-user-plus fa-2x"></i>
                        <p>Tambah User</p>
                    </div>
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#importExcel\\']').click()">
                        <i class="fas fa-file-import fa-2x"></i>
                        <p>Import Excel</p>
                    </div>
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#progress\\']').click()">
                        <i class="fas fa-chart-line fa-2x"></i>
                        <p>Progress User</p>
                    </div>
                    <div class="action-btn" onclick="document.querySelector('a[href=\\'#reporting\\']').click()">
                        <i class="fas fa-file-alt fa-2x"></i>
                        <p>Laporan</p>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div style="margin-top: 40px;">
                    <h3><i class="fas fa-history"></i> Aktivitas Terbaru</h3>
                    <div id="recentActivity" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 100px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat aktivitas...
                        </div>
                    </div>
                </div>
            </section>

            <!-- Manage Users Section -->
            <section id="users" class="admin-section" style="display: none;">
                <h2><i class="fas fa-users"></i> Kelola Pengguna</h2>
                
                <!-- Search and Filter -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="searchUser" placeholder="Cari nama pengguna..." 
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <select id="filterRole" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Semua Role</option>
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                    <select id="filterKelas" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Semua Kelas</option>
                        <!-- Kelas akan diisi secara dinamis -->
                    </select>
                    <button onclick="searchUsers()" class="btn-primary">
                        <i class="fas fa-search"></i> Cari
                    </button>
                    <button onclick="resetSearch()" class="btn-logout">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
                
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Role</th>
                                <th>Tanggal Daftar</th>
                                <th>Progress</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px;">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data pengguna...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <div>
                        Menampilkan <span id="currentCount">0</span> dari <span id="totalCount">0</span> pengguna
                    </div>
                    <div>
                        <button onclick="previousPage()" id="prevBtn" disabled class="btn-primary">
                            <i class="fas fa-chevron-left"></i> Sebelumnya
                        </button>
                        <span style="margin: 0 10px;">Halaman <span id="currentPage">1</span></span>
                        <button onclick="nextPage()" id="nextBtn" disabled class="btn-primary">
                            Selanjutnya <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Add User Section -->
            <section id="addUser" class="admin-section" style="display: none;">
                <h2><i class="fas fa-user-plus"></i> Tambah Pengguna Baru</h2>
                
                <div class="add-user-form">
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newUserName"><i class="fas fa-user"></i> Nama Pengguna</label>
                            <input type="text" id="newUserName" placeholder="Masukkan nama lengkap" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="userKelas"><i class="fas fa-graduation-cap"></i> Kelas</label>
                            <select id="userKelas" required>
                                <option value="">Pilih Kelas</option>
                                <!-- Kelas akan diisi secara dinamis -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="userRole"><i class="fas fa-user-tag"></i> Role</label>
                            <select id="userRole" required>
                                <option value="user">User (Bisa login dengan nama saja)</option>
                                <option value="admin">Admin (Butuh password)</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="passwordField" style="display: none;">
                            <label for="userPassword"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="userPassword" placeholder="Masukkan password untuk admin">
                            <small style="color: #666;">Password hanya diperlukan untuk admin</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="userEmail"><i class="fas fa-envelope"></i> Email (Opsional)</label>
                            <input type="email" id="userEmail" placeholder="email@contoh.com">
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn-primary" style="flex: 1;">
                                <i class="fas fa-plus"></i> Tambah Pengguna
                            </button>
                            <button type="button" onclick="document.getElementById('addUserForm').reset(); document.getElementById('passwordField').style.display = 'none';" 
                                    class="btn-logout" style="flex: 1;">
                                <i class="fas fa-redo"></i> Reset Form
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Bulk Add -->
                <div style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px;">
                    <h3><i class="fas fa-users"></i> Tambah Banyak User Sekaligus</h3>
                    <p style="color: #666;">Format: Nama,Kelas,Role,Password(opsional),Email(opsional)</p>
                    <textarea id="bulkUsers" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0;" 
                              placeholder="Contoh:
budi,Kelas 5,user,,budi@email.com
sari,Kelas 6,user,,sari@email.com
joko,Kelas 7,admin,joko123,joko@email.com"></textarea>
                    <button onclick="addBulkUsers()" class="btn-admin" style="margin-top: 10px;">
                        <i class="fas fa-user-plus"></i> Tambah Semua User
                    </button>
                </div>
            </section>

            <!-- Import Excel Section -->
            <section id="importExcel" class="admin-section" style="display: none;">
                <h2><i class="fas fa-file-import"></i> Import Data dari Excel/CSV</h2>
                
                <!-- Instructions -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-info-circle"></i> Petunjuk Import</h4>
                    <ol style="margin: 10px 0 10px 20px;">
                        <li>Download template Excel/CSV terlebih dahulu</li>
                        <li>Isi data user di Excel sesuai format kolom</li>
                        <li>Upload file Excel/CSV yang sudah diisi</li>
                        <li>Preview data sebelum import ke database</li>
                        <li>Konfirmasi import untuk menyimpan ke database</li>
                    </ol>
                    <p><strong>Format File:</strong> CSV dengan kolom: Nama, Kelas, Role, Password (opsional), Email (opsional)</p>
                </div>
                
                <!-- Import Actions -->
                <div class="import-actions">
                    <!-- Download Template -->
                    <div style="text-align: center;">
                        <div class="import-box">
                            <i class="fas fa-file-excel" style="font-size: 4rem; color: #4CAF50; margin-bottom: 15px;"></i>
                            <h4>Download Template</h4>
                            <p>Template dengan format yang benar</p>
                        </div>
                        <button onclick="downloadExcelTemplate()" class="btn-primary" style="width: 100%; padding: 15px;">
                            <i class="fas fa-download"></i> Download Template CSV
                        </button>
                    </div>
                    
                    <!-- Upload File -->
                    <div style="text-align: center;">
                        <div class="import-box" id="dropZone" 
                             ondrop="dropHandler(event)" 
                             ondragover="dragOverHandler(event)"
                             style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: #2196F3; margin-bottom: 15px;"></i>
                            <h4>Upload File</h4>
                            <p>Drag & drop file Excel/CSV di sini</p>
                            <p style="font-size: 0.9rem; color: #666;">atau</p>
                            <input type="file" id="excelFile" accept=".csv,.xlsx,.xls" style="margin-top: 10px;">
                        </div>
                        <button onclick="uploadExcelFile()" class="btn-admin" style="width: 100%; padding: 15px;">
                            <i class="fas fa-upload"></i> Upload & Preview Data
                        </button>
                    </div>
                </div>
                
                <!-- Preview Table -->
                <div id="excelPreview" style="display: none; margin-top: 40px;">
                    <h4><i class="fas fa-eye"></i> Preview Data (Akan Diimport)</h4>
                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama</th>
                                    <th>Kelas</th>
                                    <th>Role</th>
                                    <th>Password</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="excelDataPreview">
                                <!-- Data preview akan muncul di sini -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="confirmImport()" class="btn-primary" style="padding: 15px 40px; font-size: 1.1rem;">
                            <i class="fas fa-database"></i> KONFIRMASI IMPORT KE DATABASE
                        </button>
                        <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                            <i class="fas fa-exclamation-triangle"></i> Pastikan data sudah benar sebelum import
                        </p>
                    </div>
                </div>
                
                <!-- Import Status -->
                <div id="importStatus" style="margin-top: 30px;"></div>
            </section>

            <!-- Progress Tracking Section -->
            <section id="progress" class="admin-section" style="display: none;">
                <h2><i class="fas fa-chart-line"></i> Progress Tracking</h2>
                
                <!-- Filters -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-filter"></i> Filter Data</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <label for="progressKelas">Kelas</label>
                            <select id="progressKelas" style="width: 100%; padding: 10px;">
                                <option value="all">Semua Kelas</option>
                                <!-- Classes will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="progressRole">Role</label>
                            <select id="progressRole" style="width: 100%; padding: 10px;">
                                <option value="all">Semua Role</option>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label for="progressStatus">Status</label>
                            <select id="progressStatus" style="width: 100%; padding: 10px;">
                                <option value="all">Semua Status</option>
                                <option value="active">Aktif</option>
                                <option value="inactive">Belum Aktif</option>
                            </select>
                        </div>
                        <div>
                            <label for="progressSort">Urutkan</label>
                            <select id="progressSort" style="width: 100%; padding: 10px;">
                                <option value="name">Nama A-Z</option>
                                <option value="name_desc">Nama Z-A</option>
                                <option value="score">Skor Tertinggi</option>
                                <option value="days">Hari Terbanyak</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="loadProgressData()" class="btn-primary">
                            <i class="fas fa-search"></i> Terapkan Filter
                        </button>
                        <button onclick="resetProgressFilters()" class="btn-logout">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <button onclick="exportProgressToExcel()" class="btn-admin" style="margin-left: auto;">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Class Statistics -->
                <div id="classStats" style="display: none; margin-bottom: 30px;">
                    <h4><i class="fas fa-chart-bar"></i> Statistik Kelas</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users fa-2x"></i>
                            <h3 id="classTotalStudents">0</h3>
                            <p>Total Siswa</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-star fa-2x"></i>
                            <h3 id="classAverageScore">0</h3>
                            <p>Rata-rata Skor</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-trophy fa-2x"></i>
                            <h3 id="classBestScore">0</h3>
                            <p>Skor Tertinggi</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-check-circle fa-2x"></i>
                            <h3 id="classCompletion">0%</h3>
                            <p>Completion Rate</p>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Table -->
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Role</th>
                                <th>Total Hari</th>
                                <th>Total Poin</th>
                                <th>Rata-rata</th>
                                <th>Skor Tertinggi</th>
                                <th>Completion</th>
                                <th>Detail</th>
                            </tr>
                        </thead>
                        <tbody id="progressList">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 30px;">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data progress...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Progress Summary -->
                <div id="progressSummary" style="margin-top: 30px; padding: 20px; background: #e8f4fd; border-radius: 8px; display: none;">
                    <h4><i class="fas fa-chart-pie"></i> Progress Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 15px;">
                        <div>
                            <canvas id="progressChart" width="400" height="200"></canvas>
                        </div>
                        <div>
                            <div id="summaryStats">
                                <!-- Summary stats will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reporting Section -->
            <section id="reporting" class="admin-section" style="display: none;">
                <h2><i class="fas fa-file-alt"></i> Reporting & Analytics</h2>
                
                <!-- Report Type Selection -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-clipboard-list"></i> Pilih Jenis Laporan</h4>
                    <div class="quick-actions">
                        <div class="action-btn" onclick="generateDailyReport()">
                            <i class="fas fa-calendar-day fa-2x"></i>
                            <p>Laporan Harian</p>
                        </div>
                        <div class="action-btn" onclick="generateWeeklyReport()">
                            <i class="fas fa-calendar-week fa-2x"></i>
                            <p>Laporan Mingguan</p>
                        </div>
                        <div class="action-btn" onclick="generateMonthlyReport()">
                            <i class="fas fa-calendar-alt fa-2x"></i>
                            <p>Laporan Bulanan</p>
                        </div>
                        <div class="action-btn" onclick="generateClassReport()">
                            <i class="fas fa-school fa-2x"></i>
                            <p>Laporan Per Kelas</p>
                        </div>
                        <div class="action-btn" onclick="generateStudentReport()">
                            <i class="fas fa-user-graduate fa-2x"></i>
                            <p>Laporan Per Siswa</p>
                        </div>
                        <div class="action-btn" onclick="generateHabitsReport()">
                            <i class="fas fa-chart-pie fa-2x"></i>
                            <p>Analisis Kebiasaan</p>
                        </div>
                    </div>
                </div>
                
                <!-- Report Filters -->
                <div id="reportFilters" style="display: none; background: #e8f4fd; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4><i class="fas fa-filter"></i> Filter Laporan</h4>
                    <div id="filterContainer">
                        <!-- Filters will be loaded based on report type -->
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button onclick="generateReport()" class="btn-primary">
                            <i class="fas fa-play"></i> Generate Report
                        </button>
                        <button onclick="cancelReport()" class="btn-logout">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
                
                <!-- Report Results -->
                <div id="reportResults" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4><i class="fas fa-file-excel"></i> Hasil Laporan</h4>
                        <div>
                            <button onclick="printReport()" class="btn-primary">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button onclick="downloadReport()" class="btn-admin">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                            <button onclick="exportReportToExcel()" class="btn-primary">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Header -->
                    <div id="reportHeader" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #2196F3;">
                        <!-- Report header will be loaded here -->
                    </div>
                    
                    <!-- Report Content -->
                    <div id="reportContent">
                        <!-- Report content will be loaded here -->
                    </div>
                    
                    <!-- Report Charts -->
                    <div id="reportCharts" style="margin-top: 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <canvas id="reportChart1" width="400" height="300"></canvas>
                            </div>
                            <div>
                                <canvas id="reportChart2" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h4><i class="fas fa-bolt"></i> Quick Statistics</h4>
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card" onclick="generateDailyReport()" style="cursor: pointer;">
                            <i class="fas fa-sun" style="color: #FF9800; font-size: 2rem;"></i>
                            <h3 id="todayActive">0</h3>
                            <p>Aktif Hari Ini</p>
                        </div>
                        <div class="stat-card" onclick="generateWeeklyReport()" style="cursor: pointer;">
                            <i class="fas fa-chart-line" style="color: #4CAF50; font-size: 2rem;"></i>
                            <h3 id="weeklyAvg">0</h3>
                            <p>Rata-rata Mingguan</p>
                        </div>
                        <div class="stat-card" onclick="generateClassReport()" style="cursor: pointer;">
                            <i class="fas fa-school" style="color: #2196F3; font-size: 2rem;"></i>
                            <h3 id="totalClasses">0</h3>
                            <p>Total Kelas</p>
                        </div>
                        <div class="stat-card" onclick="generateHabitsReport()" style="cursor: pointer;">
                            <i class="fas fa-star" style="color: #FFD700; font-size: 2rem;"></i>
                            <h3 id="totalPoints">0</h3>
                            <p>Total Poin</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Statistics Section -->
            <section id="stats" class="admin-section" style="display: none;">
                <h2><i class="fas fa-chart-bar"></i> Statistik Sistem</h2>
                
                <!-- Chart Container -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                    <div class="chart-box">
                        <h3>Distribusi Pengguna</h3>
                        <canvas id="userChart" width="400" height="300"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Aktivitas Harian</h3>
                        <canvas id="activityChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <!-- Detailed Stats -->
                <div class="stats-grid" style="margin-top: 40px;">
                    <div class="stat-card">
                        <i class="fas fa-users fa-2x" style="color: #2196F3;"></i>
                        <h3 id="totalUsersStat">0</h3>
                        <p>Total Pengguna</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-shield fa-2x" style="color: #4CAF50;"></i>
                        <h3 id="adminUsersStat">0</h3>
                        <p>Admin</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-history fa-2x" style="color: #FF9800;"></i>
                        <h3 id="totalHabitsStat">0</h3>
                        <p>Data Kebiasaan</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-alt fa-2x" style="color: #9C27B0;"></i>
                        <h3 id="avgHabitsStat">0</h3>
                        <p>Rata-rata/Hari</p>
                    </div>
                </div>
                
                <!-- Top Users -->
                <div style="margin-top: 40px;">
                    <h3><i class="fas fa-trophy"></i> Top 5 Pengguna Aktif</h3>
                    <div id="topUsers" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 100px;">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat data...
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Info Section -->
            <section id="system" class="admin-section" style="display: none;">
                <h2><i class="fas fa-cog"></i> System Information</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                    <!-- Database Info -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                        <h4><i class="fas fa-database"></i> Database Status</h4>
                        <div style="margin-top: 15px;">
                            <p><strong>Firebase Connection:</strong> 
                                <span id="firebaseStatus" style="color: #4CAF50;">‚úÖ Connected</span>
                            </p>
                            <p><strong>Last Sync:</strong> <span id="lastSync">-</span></p>
                            <p><strong>Collections:</strong> 
                                <span id="collectionsCount">Loading...</span>
                            </p>
                            <p><strong>Total Documents:</strong> 
                                <span id="totalDocuments">Loading...</span>
                            </p>
                        </div>
                        <button onclick="testDatabaseConnection()" class="btn-primary" style="margin-top: 15px;">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </div>
                    
                    <!-- System Health -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                        <h4><i class="fas fa-heartbeat"></i> System Health</h4>
                        <div style="margin-top: 15px;">
                            <p><strong>Browser:</strong> <span id="browserInfo">-</span></p>
                            <p><strong>Screen Resolution:</strong> <span id="screenResolution">-</span></p>
                            <p><strong>Local Storage:</strong> <span id="localStorageStatus">-</span></p>
                            <p><strong>Memory Usage:</strong> <span id="memoryUsage">-</span></p>
                        </div>
                        <button onclick="clearAdminCache()" class="btn-logout" style="margin-top: 15px;">
                            <i class="fas fa-trash"></i> Clear Cache
                        </button>
                    </div>
                </div>
                
                <!-- Backup & Restore -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h4><i class="fas fa-download"></i> Backup & Restore</h4>
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <button onclick="backupDatabase()" class="btn-primary" style="flex: 1; padding: 15px;">
                            <i class="fas fa-download"></i> Backup Database
                        </button>
                        <button onclick="restoreDatabase()" class="btn-admin" style="flex: 1; padding: 15px;">
                            <i class="fas fa-upload"></i> Restore Database
                        </button>
                    </div>
                    <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i> Backup akan mendownload semua data dalam format JSON
                    </p>
                </div>
                
                <!-- System Time -->
                <div style="margin-top: 30px; background: #e3f2fd; padding: 15px; border-radius: 8px;">
                    <h4><i class="fas fa-clock"></i> System Time</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div>
                            <strong>Waktu Server:</strong> <span id="serverTime">-</span>
                        </div>
                        <div>
                            <strong>Waktu Lokal:</strong> <span id="localTime">-</span>
                        </div>
                        <div>
                            <strong>Timezone:</strong> <span id="timezone">-</span>
                        </div>
                        <div>
                            <strong>Uptime:</strong> <span id="uptime">-</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ==============================================
        // GLOBAL VARIABLES
        // ==============================================
        let currentPage = 1;
        const usersPerPage = 10;
        let allUsers = [];
        let filteredUsers = [];
        let excelImportData = [];
        let userChartInstance = null;
        let activityChartInstance = null;
        let progressData = [];
        let currentProgressFilters = {
            kelas: 'all',
            role: 'all',
            status: 'all',
            sort: 'name'
        };
        let currentReportType = '';
        let classes = [];

        // ==============================================
        // MAIN INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("üëë Admin Dashboard Loading...");
            
            // 1. CHECK LOGIN
            if (!isLoggedIn()) {
                alert('‚ö†Ô∏è Silakan login terlebih dahulu!');
                window.location.href = 'login.html';
                return;
            }
            
            // 2. CHECK ADMIN ROLE
            const user = getCurrentUser();
            console.log("Current user:", user);
            
            if (user.role !== 'admin') {
                alert('‚ùå Hanya admin yang bisa mengakses halaman ini!');
                logout();
                return;
            }
            
            // 3. DISPLAY ADMIN NAME
            document.getElementById('adminName').textContent = `Halo, ${user.nama}`;
            
            // 4. LOAD INITIAL DATA
            await loadInitialData();
            
            // 5. SETUP EVENT LISTENERS
            setupEventListeners();
            
            // 6. START SYSTEM UPDATES
            startSystemUpdates();
            
            console.log("‚úÖ Admin Dashboard Ready!");
        });
        
        // ==============================================
        // DATA LOADING FUNCTIONS
        // ==============================================
        
        async function loadInitialData() {
            try {
                // Load classes
                await loadClasses();
                
                // Load users
                await loadAllUsers();
                
                // Load statistics
                await loadStatistics();
                
                // Load recent activity
                await loadRecentActivity();
                
                // Update system info
                updateSystemInfo();
                
                // Load quick stats
                await loadQuickStats();
                
            } catch (error) {
                console.error("Initial data load error:", error);
                alert('‚ö†Ô∏è Gagal memuat data awal: ' + error.message);
            }
        }
        
        async function loadClasses() {
            try {
                classes = await getAllClasses();
                populateClassSelects();
            } catch (error) {
                console.error("Load classes error:", error);
            }
        }
        
        function populateClassSelects() {
            const classSelects = [
                'filterKelas',
                'progressKelas',
                'userKelas'
            ];
            
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Clear existing options except first one
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);
                    
                    // Add class options
                    classes.forEach(kelas => {
                        const option = document.createElement('option');
                        option.value = kelas.nama;
                        option.textContent = kelas.nama;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        async function loadAllUsers() {
            try {
                console.log("üìã Loading all users...");
                allUsers = await getAllUsers();
                
                // Add progress data to each user
                for (let user of allUsers) {
                    user.progress = await getUserProgress(user.id);
                }
                
                // Sort by creation date (newest first)
                allUsers.sort((a, b) => {
                    return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                });
                
                filteredUsers = [...allUsers];
                displayUsers();
                updatePagination();
                
                console.log(`‚úÖ Loaded ${allUsers.length} users`);
                
            } catch (error) {
                console.error("‚ùå Error loading users:", error);
                document.getElementById('usersList').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #f44336; padding: 30px;">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Gagal memuat data pengguna: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        async function loadStatistics() {
            try {
                // Basic stats
                const totalUsers = allUsers.length;
                const adminUsers = allUsers.filter(u => u.role === 'admin').length;
                const regularUsers = totalUsers - adminUsers;
                
                // Update dashboard stats
                document.getElementById('totalUsersAdmin').textContent = totalUsers;
                document.getElementById('adminUsers').textContent = adminUsers;
                document.getElementById('regularUsers').textContent = regularUsers;
                
                // Update statistics section
                document.getElementById('totalUsersStat').textContent = totalUsers;
                document.getElementById('adminUsersStat').textContent = adminUsers;
                
                // Load habits data
                await loadHabitsStatistics();
                
                // Update charts
                updateUserChart(regularUsers, adminUsers);
                
            } catch (error) {
                console.error("Statistics load error:", error);
            }
        }
        
        async function loadHabitsStatistics() {
            try {
                if (typeof db !== 'undefined') {
                    const snapshot = await db.collection('habits').get();
                    const totalHabits = snapshot.size;
                    
                    // Calculate average per day (last 30 days)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const recentHabits = snapshot.docs.filter(doc => {
                        const data = doc.data();
                        return new Date(data.date) >= thirtyDaysAgo;
                    });
                    
                    const avgPerDay = (recentHabits.length / 30).toFixed(1);
                    
                    // Update UI
                    document.getElementById('totalHabits').textContent = totalHabits;
                    document.getElementById('totalHabitsStat').textContent = totalHabits;
                    document.getElementById('avgHabitsStat').textContent = avgPerDay;
                    
                    // Load top users
                    await loadTopUsers(snapshot);
                    
                } else {
                    document.getElementById('totalHabits').textContent = 'N/A';
                    document.getElementById('totalHabitsStat').textContent = 'N/A';
                }
            } catch (error) {
                console.error("Habits stats error:", error);
            }
        }
        
        async function loadTopUsers(habitsSnapshot) {
            try {
                // Count habits per user
                const userHabitsCount = {};
                
                habitsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const userName = data.userName;
                    
                    if (userName) {
                        userHabitsCount[userName] = (userHabitsCount[userName] || 0) + 1;
                    }
                });
                
                // Convert to array and sort
                const topUsersArray = Object.entries(userHabitsCount)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                // Display top users
                const topUsersDiv = document.getElementById('topUsers');
                if (topUsersArray.length > 0) {
                    let html = '<div style="display: grid; gap: 10px;">';
                    
                    topUsersArray.forEach((user, index) => {
                        const percentage = Math.round((user.count / habitsSnapshot.size) * 100);
                        html += `
                            <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: white; border-radius: 8px;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #2196F3; width: 30px;">
                                    ${index + 1}
                                </div>
                                <div style="flex: 1;">
                                    <strong>${user.name}</strong>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        ${user.count} data kebiasaan
                                    </div>
                                </div>
                                <div style="background: #4CAF50; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold;">
                                    ${percentage}%
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    topUsersDiv.innerHTML = html;
                } else {
                    topUsersDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-users"></i><br>
                            Belum ada data kebiasaan
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("Top users error:", error);
            }
        }
        
        async function loadRecentActivity() {
            try {
                const activityDiv = document.getElementById('recentActivity');
                
                // Get recent users (last 5)
                const recentUsers = allUsers.slice(0, 5);
                
                // Get recent habits (if available)
                let recentHabits = [];
                if (typeof db !== 'undefined') {
                    const snapshot = await db.collection('habits')
                        .orderBy('updatedAt', 'desc')
                        .limit(5)
                        .get();
                    
                    recentHabits = snapshot.docs.map(doc => doc.data());
                }
                
                // Display activity
                let html = '<div style="display: grid; gap: 10px;">';
                
                // Add user registrations
                recentUsers.forEach(user => {
                    const date = new Date(user.createdAt).toLocaleDateString('id-ID');
                    html += `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="color: #4CAF50;">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div style="flex: 1;">
                                <strong>${user.nama}</strong> mendaftar sebagai ${user.role}
                                ${user.kelas ? `(${user.kelas})` : ''}
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${date}
                            </div>
                        </div>
                    `;
                });
                
                // Add habit activities
                recentHabits.forEach(habit => {
                    const date = new Date(habit.updatedAt).toLocaleDateString('id-ID');
                    html += `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="color: #2196F3;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div style="flex: 1;">
                                <strong>${habit.userName}</strong> mengisi tracker kebiasaan
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${date}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                activityDiv.innerHTML = html;
                
            } catch (error) {
                console.error("Recent activity error:", error);
            }
        }
        
        async function loadQuickStats() {
            try {
                // Today's active users
                const today = new Date().toISOString().split('T')[0];
                const todaySnapshot = await db.collection('habits')
                    .where('date', '==', today)
                    .get();
                
                document.getElementById('todayActive').textContent = todaySnapshot.size;
                
                // Weekly average
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const weekSnapshot = await db.collection('habits')
                    .where('date', '>=', weekAgo.toISOString().split('T')[0])
                    .get();
                
                const weeklyAvg = weekSnapshot.size > 0 ? (weekSnapshot.size / 7).toFixed(1) : 0;
                document.getElementById('weeklyAvg').textContent = weeklyAvg;
                
                // Total classes
                document.getElementById('totalClasses').textContent = classes.length;
                
                // Total points
                let totalPoints = 0;
                const habitsSnapshot = await db.collection('habits').get();
                habitsSnapshot.forEach(doc => {
                    totalPoints += doc.data().points || 0;
                });
                document.getElementById('totalPoints').textContent = totalPoints;
                
            } catch (error) {
                console.error("Quick stats error:", error);
            }
        }
        
        // ==============================================
        // USER MANAGEMENT FUNCTIONS
        // ==============================================
        
        function displayUsers() {
            const tbody = document.getElementById('usersList');
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = filteredUsers.slice(startIndex, endIndex);
            
            if (pageUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-users-slash"></i><br>
                            Tidak ada pengguna yang ditemukan
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            pageUsers.forEach((user, index) => {
                const globalIndex = startIndex + index + 1;
                const progress = user.progress;
                const totalDays = progress ? progress.totalDays : 0;
                const completionRate = progress ? progress.completionRate : 0;
                
                // Progress bar
                let progressColor = 'completion-none';
                let progressText = 'Belum Aktif';
                
                if (completionRate >= 70) {
                    progressColor = 'completion-excellent';
                    progressText = 'Sangat Baik';
                } else if (completionRate >= 40) {
                    progressColor = 'completion-good';
                    progressText = 'Cukup Baik';
                } else if (completionRate > 0) {
                    progressColor = 'completion-poor';
                    progressText = 'Perlu Peningkatan';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td>
                        <strong>${user.nama}</strong>
                        ${user.email ? `<br><small style="color: #666;">${user.email}</small>` : ''}
                    </td>
                    <td>${user.kelas || '-'}</td>
                    <td>
                        <span class="role-badge ${user.role}">
                            ${user.role === 'admin' ? 'ADMIN' : 'USER'}
                        </span>
                    </td>
                    <td>
                        ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('id-ID') : '-'}
                        ${user.imported ? '<br><small style="color: #666;">(imported)</small>' : ''}
                    </td>
                    <td>
                        ${totalDays > 0 ? `
                            <div style="font-size: 0.9rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${totalDays} hari</span>
                                    <span>${completionRate}%</span>
                                </div>
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small ${progressColor}" style="width: ${completionRate}%"></div>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                                    ${progressText}
                                </div>
                            </div>
                        ` : '<span style="color: #666;">Belum ada data</span>'}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editUser('${user.id}', '${user.nama}')" 
                                    class="btn-primary" style="padding: 5px 10px;" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            
                            ${user.nama !== 'admin' ? 
                                `<button onclick="deleteUserById('${user.id}', '${user.nama}')" 
                                        class="btn-delete" style="padding: 5px 10px;" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>` 
                                : ''
                            }
                            
                            ${user.role === 'user' ? 
                                `<button onclick="makeAdmin('${user.id}', '${user.nama}')" 
                                        class="btn-admin" style="padding: 5px 10px;" title="Jadikan Admin">
                                    <i class="fas fa-user-shield"></i>
                                </button>` 
                                : ''
                            }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update counts
            document.getElementById('currentCount').textContent = pageUsers.length;
            document.getElementById('totalCount').textContent = filteredUsers.length;
            document.getElementById('currentPage').textContent = currentPage;
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }
        
        function searchUsers() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const kelasFilter = document.getElementById('filterKelas').value;
            
            filteredUsers = allUsers.filter(user => {
                const nameMatch = user.nama.toLowerCase().includes(searchTerm);
                const roleMatch = !roleFilter || user.role === roleFilter;
                const kelasMatch = !kelasFilter || user.kelas === kelasFilter;
                return nameMatch && roleMatch && kelasMatch;
            });
            
            currentPage = 1;
            displayUsers();
            updatePagination();
        }
        
        function resetSearch() {
            document.getElementById('searchUser').value = '';
            document.getElementById('filterRole').value = '';
            document.getElementById('filterKelas').value = '';
            filteredUsers = [...allUsers];
            currentPage = 1;
            displayUsers();
            updatePagination();
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayUsers();
                updatePagination();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayUsers();
                updatePagination();
            }
        }
        
        // ==============================================
        // USER CRUD OPERATIONS
        // ==============================================
        
        async function editUser(userId, userName) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const newName = prompt(`Edit nama untuk ${userName}:`, userName);
            if (newName && newName.trim() && newName !== userName) {
                try {
                    await db.collection('users').doc(userId).update({
                        nama: newName.trim(),
                        updatedAt: new Date().toISOString()
                    });
                    
                    alert('‚úÖ Nama berhasil diubah!');
                    await loadAllUsers();
                    
                } catch (error) {
                    alert('‚ùå Gagal mengubah nama: ' + error.message);
                }
            }
        }
        
        async function deleteUserById(userId, userName) {
            if (!confirm(`Hapus user "${userName}"?\n\nSEMUA data kebiasaan user ini juga akan dihapus!`)) {
                return;
            }
            
            try {
                // Delete user
                await db.collection('users').doc(userId).delete();
                
                // Delete user's habits
                const habitsSnapshot = await db.collection('habits')
                    .where('userId', '==', userId)
                    .get();
                
                const batch = db.batch();
                habitsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                if (habitsSnapshot.size > 0) {
                    await batch.commit();
                }
                
                alert(`‚úÖ User "${userName}" dan ${habitsSnapshot.size} data kebiasaan berhasil dihapus!`);
                await loadAllUsers();
                
            } catch (error) {
                alert('‚ùå Gagal menghapus user: ' + error.message);
            }
        }
        
        async function makeAdmin(userId, userName) {
            if (!confirm(`Jadikan "${userName}" sebagai Admin?\n\nUser akan bisa login dengan password.`)) {
                return;
            }
            
            const password = prompt('Masukkan password untuk admin baru:', 'admin123');
            if (!password) {
                alert('‚ùå Password diperlukan untuk admin!');
                return;
            }
            
            try {
                await db.collection('users').doc(userId).update({
                    role: 'admin',
                    password: password,
                    updatedAt: new Date().toISOString(),
                    promotedBy: getCurrentUser().nama
                });
                
                alert(`‚úÖ "${userName}" sekarang menjadi Admin!`);
                await loadAllUsers();
                
            } catch (error) {
                alert('‚ùå Gagal mengubah role: ' + error.message);
            }
        }
        
        // ==============================================
        // ADD USER FUNCTIONS
        // ==============================================
        
        function setupEventListeners() {
            // Add user form
            const addForm = document.getElementById('addUserForm');
            if (addForm) {
                // Show/hide password field based on role
                document.getElementById('userRole').addEventListener('change', function() {
                    const passwordField = document.getElementById('passwordField');
                    passwordField.style.display = this.value === 'admin' ? 'block' : 'none';
                });
                
                // Handle form submit
                addForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const nama = document.getElementById('newUserName').value.trim();
                    const kelas = document.getElementById('userKelas').value;
                    const role = document.getElementById('userRole').value;
                    const password = document.getElementById('userPassword').value;
                    const email = document.getElementById('userEmail').value.trim();
                    
                    if (!nama) {
                        alert('‚ö†Ô∏è Nama tidak boleh kosong!');
                        return;
                    }
                    
                    if (nama.length < 3) {
                        alert('‚ö†Ô∏è Nama minimal 3 karakter!');
                        return;
                    }
                    
                    if (!kelas) {
                        alert('‚ö†Ô∏è Pilih kelas terlebih dahulu!');
                        return;
                    }
                    
                    // If admin but no password
                    if (role === 'admin' && !password) {
                        alert('‚ö†Ô∏è Password diperlukan untuk admin!');
                        return;
                    }
                    
                    const btn = this.querySelector('button[type="submit"]');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menambahkan...';
                    btn.disabled = true;
                    
                    try {
                        const result = await addUserWithClass(nama, role, kelas, email, password);
                        
                        if (result.success) {
                            alert('‚úÖ ' + result.message);
                            
                            // Reset form
                            addForm.reset();
                            document.getElementById('passwordField').style.display = 'none';
                            
                            // Reload data
                            await loadAllUsers();
                            await loadStatistics();
                            
                        } else {
                            alert('‚ùå ' + result.message);
                        }
                        
                    } catch (error) {
                        alert('‚ùå Error: ' + error.message);
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                });
            }
            
            // Bulk add users
            window.addBulkUsers = async function() {
                const textarea = document.getElementById('bulkUsers');
                const lines = textarea.value.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                if (lines.length === 0) {
                    alert('‚ö†Ô∏è Masukkan data user terlebih dahulu!');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (const line of lines) {
                    const parts = line.split(',').map(part => part.trim());
                    if (parts.length >= 3) {
                        const [nama, kelas, role] = parts;
                        const password = parts[3] || '';
                        const email = parts[4] || '';
                        
                        try {
                            const result = await addUserWithClass(nama, role, kelas, email, password);
                            if (result.success) {
                                successCount++;
                            } else {
                                errorCount++;
                                errors.push(`${nama}: ${result.message}`);
                            }
                        } catch (error) {
                            errorCount++;
                            errors.push(`${nama}: ${error.message}`);
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                alert(`‚úÖ Selesai!\nBerhasil: ${successCount}\nGagal: ${errorCount}`);
                
                if (errors.length > 0) {
                    console.error("Bulk add errors:", errors);
                }
                
                // Clear textarea
                textarea.value = '';
                
                // Reload data
                await loadAllUsers();
                await loadStatistics();
            };
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    document.querySelectorAll('.sidebar-menu a').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const targetId = this.getAttribute('href').substring(1);
                    document.querySelectorAll('.admin-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        
                        // Refresh data for specific sections
                        if (targetId === 'users') {
                            loadAllUsers();
                        } else if (targetId === 'progress') {
                            loadProgressData();
                        } else if (targetId === 'stats') {
                            loadStatistics();
                        } else if (targetId === 'system') {
                            updateSystemInfo();
                        }
                    }
                });
            });
            
            // File upload handling
            const fileInput = document.getElementById('excelFile');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
                    document.querySelector('#dropZone p').textContent = `File: ${fileName}`;
                });
            }
        }
        
        // ==============================================
        // EXCEL IMPORT FUNCTIONS
        // ==============================================
        
        function dragOverHandler(event) {
            event.preventDefault();
            event.currentTarget.style.background = '#e3f2fd';
        }
        
        function dropHandler(event) {
            event.preventDefault();
            event.currentTarget.style.background = '#f9f9f9';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('excelFile').files = files;
                const fileName = files[0].name;
                document.querySelector('#dropZone p').textContent = `File: ${fileName}`;
            }
        }
        
        function downloadExcelTemplate() {
            // Create CSV template
            const template = `Nama,Kelas,Role,Password (opsional),Email (opsional)
admin,Kelas 1,admin,admin123,admin@example.com
budi,Kelas 5,user,,budi@example.com
sari,Kelas 6,user,,sari@example.com
joko,Kelas 7,admin,joko123,joko@example.com
anin,Kelas 8,user,,anin@example.com`;

            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'template_import_user.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Template berhasil didownload!');
        }
        
        async function uploadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ö†Ô∏è Pilih file Excel/CSV terlebih dahulu!');
                return;
            }
            
            try {
                // Show loading
                document.getElementById('excelPreview').style.display = 'none';
                document.getElementById('importStatus').innerHTML = `
                    <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px;">
                        <i class="fas fa-spinner fa-spin"></i> Membaca file...
                    </div>
                `;
                
                // Read file
                const data = await readCSVFile(file);
                excelImportData = data;
                
                // Show preview
                showExcelPreview(data);
                
            } catch (error) {
                console.error('File read error:', error);
                alert('‚ùå Gagal membaca file: ' + error.message);
                document.getElementById('importStatus').innerHTML = '';
            }
        }
        
        function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        const data = [];
                        
                        // Skip header (first line)
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // Handle CSV with quotes and commas
                            const columns = line.split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                            
                            if (columns.length >= 3) {
                                const nama = columns[0];
                                const kelas = columns[1];
                                const role = columns[2].toLowerCase() === 'admin' ? 'admin' : 'user';
                                const password = columns[3] || '';
                                const email = columns[4] || '';
                                
                                if (nama && nama.length >= 2 && kelas) {
                                    data.push({
                                        nama: nama,
                                        kelas: kelas,
                                        role: role,
                                        password: password,
                                        email: email,
                                        status: 'pending'
                                    });
                                }
                            }
                        }
                        
                        resolve(data);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    // For Excel files, you'd need SheetJS library
                    alert('‚ö†Ô∏è Untuk file Excel (.xlsx), konversi ke CSV dulu atau gunakan file CSV.');
                    reject(new Error('Hanya file CSV yang didukung'));
                }
            });
        }
        
        function showExcelPreview(data) {
            const previewDiv = document.getElementById('excelPreview');
            const tbody = document.getElementById('excelDataPreview');
            
            if (data.length === 0) {
                document.getElementById('importStatus').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Tidak ada data yang valid ditemukan dalam file.
                    </div>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${item.nama}</strong></td>
                    <td>${item.kelas}</td>
                    <td>
                        <span class="role-badge ${item.role}">
                            ${item.role.toUpperCase()}
                        </span>
                    </td>
                    <td>${item.password || '<em>auto</em>'}</td>
                    <td>${item.email || '-'}</td>
                    <td>
                        <span class="status-badge pending">
                            <i class="fas fa-clock"></i> Menunggu
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
            document.getElementById('importStatus').innerHTML = `
                <div style="background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <i class="fas fa-info-circle"></i>
                    <strong> ${data.length} user</strong> siap diimport. 
                    Password kosong akan diisi otomatis: "user123" untuk user, "admin123" untuk admin.
                </div>
            `;
        }
        
        async function confirmImport() {
            if (excelImportData.length === 0) {
                alert('‚ö†Ô∏è Tidak ada data untuk diimport!');
                return;
            }
            
            if (!confirm(`Import ${excelImportData.length} user ke database?\n\nProses ini mungkin memakan waktu beberapa detik.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = `
                <div style="background: #fff3cd; color: #856404; padding: 20px; border-radius: 8px;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <strong> Sedang mengimport data...</strong>
                    <div id="importProgress" style="margin-top: 15px; font-size: 0.9rem;">
                        Memulai import (0/${excelImportData.length})...
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
                            <div id="importProgressBar" style="height: 100%; width: 0%; background: #4CAF50; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            const rows = document.querySelectorAll('#excelDataPreview tr');
            
            // Import each user
            for (let i = 0; i < excelImportData.length; i++) {
                const user = excelImportData[i];
                
                // Update progress
                const progress = Math.round(((i + 1) / excelImportData.length) * 100);
                document.getElementById('importProgress').innerHTML = 
                    `Memproses ${i + 1}/${excelImportData.length}: ${user.nama}`;
                document.getElementById('importProgressBar').style.width = `${progress}%`;
                
                try {
                    // Check if user exists
                    const checkSnapshot = await db.collection('users')
                        .where('nama', '==', user.nama)
                        .limit(1)
                        .get();
                    
                    const userData = {
                        nama: user.nama,
                        kelas: user.kelas,
                        role: user.role,
                        email: user.email || '',
                        createdAt: new Date().toISOString(),
                        imported: true,
                        importedAt: new Date().toISOString(),
                        importedBy: getCurrentUser().nama
                    };
                    
                    // Add password if provided or use default
                    if (user.password) {
                        userData.password = user.password;
                    } else if (user.role === 'admin') {
                        userData.password = 'admin123';
                    }
                    
                    if (checkSnapshot.empty) {
                        // Add new user
                        await db.collection('users').add(userData);
                        
                        // Update row status
                        if (rows[i]) {
                            rows[i].querySelector('.status-badge').innerHTML = 
                                '<i class="fas fa-check" style="color: #4CAF50;"></i> Berhasil';
                            rows[i].querySelector('.status-badge').className = 'status-badge success';
                        }
                        
                        successCount++;
                    } else {
                        // Update existing user
                        const docId = checkSnapshot.docs[0].id;
                        await db.collection('users').doc(docId).update({
                            kelas: user.kelas,
                            role: user.role,
                            updatedAt: new Date().toISOString(),
                            lastImport: new Date().toISOString()
                        });
                        
                        // Update row status
                        if (rows[i]) {
                            rows[i].querySelector('.status-badge').innerHTML = 
                                '<i class="fas fa-sync" style="color: #2196F3;"></i> Diupdate';
                            rows[i].querySelector('.status-badge').className = 'status-badge updated';
                        }
                        
                        successCount++;
                    }
                    
                } catch (error) {
                    errorCount++;
                    errors.push(`${user.nama}: ${error.message}`);
                    
                    // Update row status
                    if (rows[i]) {
                        rows[i].querySelector('.status-badge').innerHTML = 
                            '<i class="fas fa-times" style="color: #f44336;"></i> Error';
                        rows[i].querySelector('.status-badge').className = 'status-badge error';
                    }
                }
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Show final result
            let resultHtml = `
                <div style="background: #d4edda; color: #155724; padding: 25px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="margin: 0 0 20px 0;"><i class="fas fa-check-circle"></i> IMPORT SELESAI</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 2rem; color: #4CAF50; font-weight: bold;">${successCount}</div>
                            <div style="font-size: 0.9rem;">Berhasil</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 2rem; color: ${errorCount > 0 ? '#f44336' : '#4CAF50'}; font-weight: bold;">${errorCount}</div>
                            <div style="font-size: 0.9rem;">Gagal</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 2rem; color: #2196F3; font-weight: bold;">${excelImportData.length}</div>
                            <div style="font-size: 0.9rem;">Total</div>
                        </div>
                    </div>
            `;
            
            if (errors.length > 0) {
                resultHtml += `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin-top: 20px;">
                        <strong><i class="fas fa-exclamation-triangle"></i> Error Details:</strong>
                        <ul style="margin: 10px 0 0 20px; font-size: 0.9rem;">
                            ${errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            resultHtml += `
                <div style="margin-top: 25px; display: flex; gap: 15px;">
                    <button onclick="location.reload()" class="btn-primary" style="flex: 1;">
                        <i class="fas fa-redo"></i> Refresh Data
                    </button>
                    <button onclick="downloadExcelTemplate()" class="btn-admin" style="flex: 1;">
                        <i class="fas fa-download"></i> Template Lagi
                    </button>
                </div>
            </div>`;
            
            statusDiv.innerHTML = resultHtml;
        }
        
        // ==============================================
        // PROGRESS TRACKING FUNCTIONS
        // ==============================================
        
        async function loadProgressData() {
            try {
                const progressList = document.getElementById('progressList');
                progressList.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 30px;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat data progress...
                        </td>
                    </tr>
                `;
                
                // Update filters
                currentProgressFilters = {
                    kelas: document.getElementById('progressKelas').value,
                    role: document.getElementById('progressRole').value,
                    status: document.getElementById('progressStatus').value,
                    sort: document.getElementById('progressSort').value
                };
                
                // Get users based on filters
                let query = db.collection('users');
                
                if (currentProgressFilters.kelas !== 'all') {
                    query = query.where('kelas', '==', currentProgressFilters.kelas);
                }
                
                if (currentProgressFilters.role !== 'all') {
                    query = query.where('role', '==', currentProgressFilters.role);
                }
                
                const snapshot = await query.get();
                const users = [];
                
                // Get progress for each user
                for (const doc of snapshot.docs) {
                    const userData = doc.data();
                    const progress = await getUserProgress(doc.id);
                    
                    users.push({
                        id: doc.id,
                        ...userData,
                        progress: progress
                    });
                }
                
                // Apply status filter
                if (currentProgressFilters.status !== 'all') {
                    progressData = users.filter(user => {
                        if (currentProgressFilters.status === 'active') {
                            return user.progress && user.progress.totalDays > 0;
                        } else {
                            return !user.progress || user.progress.totalDays === 0;
                        }
                    });
                } else {
                    progressData = users;
                }
                
                // Apply sorting
                sortProgressData();
                
                // Display data
                displayProgressData();
                
                // Load class statistics if class filter is applied
                if (currentProgressFilters.kelas !== 'all') {
                    await loadClassStatistics(currentProgressFilters.kelas);
                } else {
                    document.getElementById('classStats').style.display = 'none';
                }
                
                // Generate summary
                generateProgressSummary();
                
            } catch (error) {
                console.error("Load progress error:", error);
                document.getElementById('progressList').innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: #f44336; padding: 30px;">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Gagal memuat data: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function sortProgressData() {
            switch (currentProgressFilters.sort) {
                case 'name':
                    progressData.sort((a, b) => a.nama.localeCompare(b.nama));
                    break;
                case 'name_desc':
                    progressData.sort((a, b) => b.nama.localeCompare(a.nama));
                    break;
                case 'score':
                    progressData.sort((a, b) => {
                        const scoreA = a.progress ? a.progress.bestScore : 0;
                        const scoreB = b.progress ? b.progress.bestScore : 0;
                        return scoreB - scoreA;
                    });
                    break;
                case 'days':
                    progressData.sort((a, b) => {
                        const daysA = a.progress ? a.progress.totalDays : 0;
                        const daysB = b.progress ? b.progress.totalDays : 0;
                        return daysB - daysA;
                    });
                    break;
            }
        }
        
        function displayProgressData() {
            const tbody = document.getElementById('progressList');
            
            if (progressData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-users-slash"></i><br>
                            Tidak ada data yang sesuai dengan filter
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            progressData.forEach((user, index) => {
                const progress = user.progress;
                const totalDays = progress ? progress.totalDays : 0;
                const totalPoints = progress ? progress.totalPoints : 0;
                const averageScore = progress ? progress.averageScore : 0;
                const bestScore = progress ? progress.bestScore : 0;
                const completionRate = progress ? progress.completionRate : 0;
                
                // Determine status color
                let statusColor = '#f44336'; // red for inactive
                let statusText = 'Belum Aktif';
                
                if (totalDays > 0) {
                    if (completionRate >= 70) {
                        statusColor = '#4CAF50'; // green for good
                        statusText = 'Sangat Baik';
                    } else if (completionRate >= 40) {
                        statusColor = '#FF9800'; // orange for average
                        statusText = 'Cukup Baik';
                    } else {
                        statusColor = '#2196F3'; // blue for low
                        statusText = 'Perlu Peningkatan';
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <strong>${user.nama}</strong>
                        ${user.email ? `<br><small style="color: #666;">${user.email}</small>` : ''}
                    </td>
                    <td>${user.kelas || '-'}</td>
                    <td>
                        <span class="role-badge ${user.role}">
                            ${user.role === 'admin' ? 'ADMIN' : 'USER'}
                        </span>
                    </td>
                    <td style="text-align: center; font-weight: bold;">${totalDays}</td>
                    <td style="text-align: center; font-weight: bold; color: #4CAF50;">${totalPoints}</td>
                    <td style="text-align: center; font-weight: bold;">${averageScore}</td>
                    <td style="text-align: center; font-weight: bold; color: #FF9800;">${bestScore}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${completionRate}%; background: ${statusColor};"></div>
                            </div>
                            <span style="font-size: 0.9rem; color: ${statusColor}; font-weight: bold;">
                                ${completionRate}%
                            </span>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            ${statusText}
                        </div>
                    </td>
                    <td>
                        <button onclick="viewUserDetail('${user.id}', '${user.nama}')" 
                                class="btn-primary" style="padding: 5px 10px;" title="Lihat Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function loadClassStatistics(kelas) {
            try {
                const stats = await getClassStatistics(kelas);
                
                if (stats) {
                    document.getElementById('classStats').style.display = 'block';
                    document.getElementById('classTotalStudents').textContent = stats.totalStudents;
                    document.getElementById('classAverageScore').textContent = stats.averageScore;
                    document.getElementById('classBestScore').textContent = stats.bestScore;
                    document.getElementById('classCompletion').textContent = `${stats.completionRate}%`;
                }
            } catch (error) {
                console.error("Class stats error:", error);
            }
        }
        
        function generateProgressSummary() {
            if (progressData.length === 0) {
                document.getElementById('progressSummary').style.display = 'none';
                return;
            }
            
            const summaryDiv = document.getElementById('summaryStats');
            let totalDays = 0;
            let totalPoints = 0;
            let activeUsers = 0;
            let bestUser = '';
            let bestScore = 0;
            let totalCompletion = 0;
            
            progressData.forEach(user => {
                if (user.progress) {
                    totalDays += user.progress.totalDays;
                    totalPoints += user.progress.totalPoints;
                    totalCompletion += user.progress.completionRate;
                    
                    if (user.progress.totalDays > 0) {
                        activeUsers++;
                    }
                    
                    if (user.progress.bestScore > bestScore) {
                        bestScore = user.progress.bestScore;
                        bestUser = user.nama;
                    }
                }
            });
            
            const averageDays = progressData.length > 0 ? (totalDays / progressData.length).toFixed(1) : 0;
            const averagePoints = progressData.length > 0 ? (totalPoints / progressData.length).toFixed(1) : 0;
            const averageCompletion = progressData.length > 0 ? (totalCompletion / progressData.length).toFixed(1) : 0;
            
            summaryDiv.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div>
                        <strong>Total Users:</strong> ${progressData.length}
                        <div style="font-size: 0.9rem; color: #666;">
                            ${activeUsers} aktif, ${progressData.length - activeUsers} belum aktif
                        </div>
                    </div>
                    <div>
                        <strong>Rata-rata Hari:</strong> ${averageDays} hari/user
                    </div>
                    <div>
                        <strong>Rata-rata Poin:</strong> ${averagePoints} poin/user
                    </div>
                    <div>
                        <strong>Rata-rata Completion:</strong> ${averageCompletion}%
                    </div>
                    <div>
                        <strong>User Terbaik:</strong> ${bestUser || '-'}
                        <div style="font-size: 0.9rem; color: #666;">
                            Skor: ${bestScore} poin
                        </div>
                    </div>
                </div>
            `;
            
            // Update chart
            updateProgressChart();
            
            document.getElementById('progressSummary').style.display = 'block';
        }
        
        function updateProgressChart() {
            const ctx = document.getElementById('progressChart');
            if (!ctx) return;
            
            // Calculate distribution
            const distribution = {
                excellent: 0, // > 70%
                good: 0,      // 40-70%
                poor: 0,      // < 40%
                inactive: 0   // no data
            };
            
            progressData.forEach(user => {
                if (!user.progress || user.progress.totalDays === 0) {
                    distribution.inactive++;
                } else if (user.progress.completionRate >= 70) {
                    distribution.excellent++;
                } else if (user.progress.completionRate >= 40) {
                    distribution.good++;
                } else {
                    distribution.poor++;
                }
            });
            
            // Create chart
            const chartCtx = ctx.getContext('2d');
            
            // Destroy existing chart
            if (window.progressChartInstance) {
                window.progressChartInstance.destroy();
            }
            
            window.progressChartInstance = new Chart(chartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Sangat Baik (>70%)', 'Cukup Baik (40-70%)', 'Perlu Peningkatan (<40%)', 'Belum Aktif'],
                    datasets: [{
                        data: [distribution.excellent, distribution.good, distribution.poor, distribution.inactive],
                        backgroundColor: ['#4CAF50', '#FF9800', '#2196F3', '#f44336'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} users (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function resetProgressFilters() {
            document.getElementById('progressKelas').value = 'all';
            document.getElementById('progressRole').value = 'all';
            document.getElementById('progressStatus').value = 'all';
            document.getElementById('progressSort').value = 'name';
            loadProgressData();
        }
        
        async function exportProgressToExcel() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
                btn.disabled = true;
                
                // Collect data
                const data = [];
                
                for (const user of progressData) {
                    const progress = user.progress;
                    
                    data.push({
                        'No': data.length + 1,
                        'Nama': user.nama,
                        'Kelas': user.kelas || '-',
                        'Role': user.role,
                        'Email': user.email || '-',
                        'Total Hari': progress ? progress.totalDays : 0,
                        'Total Poin': progress ? progress.totalPoints : 0,
                        'Rata-rata': progress ? progress.averageScore : 0,
                        'Skor Tertinggi': progress ? progress.bestScore : 0,
                        'Completion Rate': progress ? `${progress.completionRate}%` : '0%',
                        'Status': progress && progress.totalDays > 0 ? 'Aktif' : 'Belum Aktif'
                    });
                }
                
                if (data.length === 0) {
                    alert('‚ö†Ô∏è Tidak ada data untuk diexport!');
                    return;
                }
                
                // Convert to CSV
                const headers = Object.keys(data[0]);
                const csvRows = [
                    headers.join(','),
                    ...data.map(row => headers.map(header => {
                        const cell = row[header];
                        // Escape commas and quotes
                        if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"'))) {
                            return `"${cell.replace(/"/g, '""')}"`;
                        }
                        return cell;
                    }).join(','))
                ];
                
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                const dateStr = new Date().toISOString().split('T')[0];
                link.href = url;
                link.download = `progress_report_${dateStr}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Data berhasil diexport!\nTotal: ${data.length} records`);
                
            } catch (error) {
                console.error("Export error:", error);
                alert('‚ùå Gagal export: ' + error.message);
            } finally {
                event.target.innerHTML = '<i class="fas fa-file-excel"></i> Export Excel';
                event.target.disabled = false;
            }
        }
        
        function viewUserDetail(userId, userName) {
            // Implement modal or page for detailed view
            alert(`Detail untuk ${userName}\n\nFitur ini akan dikembangkan lebih lanjut.`);
        }
        
        // ==============================================
        // REPORTING FUNCTIONS (Basic Implementation)
        // ==============================================
        
        function generateDailyReport() {
            currentReportType = 'daily';
            showReportFilters();
        }
        
        function generateWeeklyReport() {
            currentReportType = 'weekly';
            showReportFilters();
        }
        
        function generateMonthlyReport() {
            currentReportType = 'monthly';
            showReportFilters();
        }
        
        function generateClassReport() {
            currentReportType = 'class';
            showReportFilters();
        }
        
        function generateStudentReport() {
            currentReportType = 'student';
            showReportFilters();
        }
        
        function generateHabitsReport() {
            currentReportType = 'habits';
            showReportFilters();
        }
        
        function showReportFilters() {
            const filterContainer = document.getElementById('filterContainer');
            let html = '';
            
            switch (currentReportType) {
                case 'daily':
                    html = `
                        <div class="form-group">
                            <label for="reportDate">Pilih Tanggal</label>
                            <input type="date" id="reportDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px;">
                        </div>
                    `;
                    break;
                case 'weekly':
                    html = `
                        <div class="form-group">
                            <label for="reportWeek">Pilih Minggu</label>
                            <input type="week" id="reportWeek" style="width: 100%; padding: 10px;">
                        </div>
                    `;
                    break;
                case 'monthly':
                    html = `
                        <div class="form-group">
                            <label for="reportMonth">Pilih Bulan</label>
                            <input type="month" id="reportMonth" value="${new Date().toISOString().slice(0,7)}" style="width: 100%; padding: 10px;">
                        </div>
                    `;
                    break;
                case 'class':
                    html = `
                        <div class="form-group">
                            <label for="reportClass">Pilih Kelas</label>
                            <select id="reportClass" style="width: 100%; padding: 10px;">
                                <option value="all">Semua Kelas</option>
                                ${classes.map(k => `<option value="${k.nama}">${k.nama}</option>`).join('')}
                            </select>
                        </div>
                    `;
                    break;
                case 'student':
                    html = `
                        <div class="form-group">
                            <label for="reportStudent">Pilih Siswa</label>
                            <select id="reportStudent" style="width: 100%; padding: 10px;">
                                <option value="">Pilih Siswa</option>
                                ${allUsers.map(u => `<option value="${u.id}">${u.nama} (${u.kelas || '-'})</option>`).join('')}
                            </select>
                        </div>
                    `;
                    break;
                case 'habits':
                    html = `
                        <div class="form-group">
                            <label for="habitType">Jenis Kebiasaan</label>
                            <select id="habitType" style="width: 100%; padding: 10px;">
                                <option value="all">Semua Kebiasaan</option>
                                <option value="bangunPagi">Bangun Pagi</option>
                                <option value="sholat">Sholat</option>
                                <option value="olahraga">Olahraga</option>
                                <option value="makan">Makan Sehat</option>
                                <option value="belajar">Belajar</option>
                                <option value="bantuOrtu">Bantu Orang Tua</option>
                                <option value="tidur">Tidur Cepat</option>
                            </select>
                        </div>
                    `;
                    break;
            }
            
            filterContainer.innerHTML = html;
            document.getElementById('reportFilters').style.display = 'block';
            document.getElementById('reportResults').style.display = 'none';
        }
        
        async function generateReport() {
            try {
                // Show loading
                document.getElementById('reportResults').style.display = 'block';
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                        <p>Membuat laporan...</p>
                    </div>
                `;
                
                // Generate report based on type
                let reportHtml = '';
                let reportTitle = '';
                
                switch (currentReportType) {
                    case 'daily':
                        reportTitle = 'Laporan Harian';
                        reportHtml = await generateDailyReportContent();
                        break;
                    case 'weekly':
                        reportTitle = 'Laporan Mingguan';
                        reportHtml = await generateWeeklyReportContent();
                        break;
                    case 'monthly':
                        reportTitle = 'Laporan Bulanan';
                        reportHtml = await generateMonthlyReportContent();
                        break;
                    case 'class':
                        reportTitle = 'Laporan Per Kelas';
                        reportHtml = await generateClassReportContent();
                        break;
                    case 'student':
                        reportTitle = 'Laporan Per Siswa';
                        reportHtml = await generateStudentReportContent();
                        break;
                    case 'habits':
                        reportTitle = 'Analisis Kebiasaan';
                        reportHtml = await generateHabitsReportContent();
                        break;
                }
                
                // Update report header
                document.getElementById('reportHeader').innerHTML = `
                    <h3 style="margin: 0;">${reportTitle}</h3>
                    <p style="margin: 5px 0 0 0; color: #666;">
                        Dibuat pada: ${new Date().toLocaleString('id-ID')}
                    </p>
                `;
                
                // Update report content
                document.getElementById('reportContent').innerHTML = reportHtml;
                
                // Hide filters
                document.getElementById('reportFilters').style.display = 'none';
                
            } catch (error) {
                console.error("Generate report error:", error);
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 40px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Gagal membuat laporan: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function generateDailyReportContent() {
            const date = document.getElementById('reportDate').value;
            const snapshot = await db.collection('habits')
                .where('date', '==', date)
                .get();
            
            if (snapshot.empty) {
                return `<p style="text-align: center; padding: 20px; color: #666;">Tidak ada data untuk tanggal ${date}</p>`;
            }
            
            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>Ringkasan Harian</h4>
                    <div class="stats-grid" style="margin-top: 15px;">
                        <div class="stat-card">
                            <h3>${snapshot.size}</h3>
                            <p>Total Pengguna Aktif</p>
                        </div>
                        <div class="stat-card">
                            <h3>${Math.round((snapshot.size / allUsers.length) * 100)}%</h3>
                            <p>Partisipasi</p>
                        </div>
                    </div>
                </div>
                
                <h4>Detail Aktivitas</h4>
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Poin</th>
                                <th>Kebiasaan Tercapai</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let index = 1;
            snapshot.forEach(doc => {
                const data = doc.data();
                const habits = data.habits || {};
                const completedHabits = Object.values(habits).filter(val => val === true || (typeof val === 'string' && val.trim() !== '')).length;
                
                html += `
                    <tr>
                        <td>${index++}</td>
                        <td>${data.userName}</td>
                        <td>${allUsers.find(u => u.id === data.userId)?.kelas || '-'}</td>
                        <td style="font-weight: bold; color: #4CAF50;">${data.points || 0}</td>
                        <td>${completedHabits}/7</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }
        
        async function generateWeeklyReportContent() {
            // Similar implementation for weekly report
            return `<p style="text-align: center; padding: 40px; color: #666;">Laporan mingguan akan tersedia di versi mendatang.</p>`;
        }
        
        async function generateMonthlyReportContent() {
            // Similar implementation for monthly report
            return `<p style="text-align: center; padding: 40px; color: #666;">Laporan bulanan akan tersedia di versi mendatang.</p>`;
        }
        
        async function generateClassReportContent() {
            const kelas = document.getElementById('reportClass').value;
            
            if (kelas === 'all') {
                let html = `<h4>Statistik Semua Kelas</h4>`;
                
                for (const k of classes) {
                    const stats = await getClassStatistics(k.nama);
                    if (stats && stats.totalStudents > 0) {
                        html += `
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
                                <h5>${k.nama}</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px;">
                                    <div>
                                        <strong>Siswa:</strong> ${stats.totalStudents}
                                    </div>
                                    <div>
                                        <strong>Rata-rata:</strong> ${stats.averageScore}
                                    </div>
                                    <div>
                                        <strong>Tertinggi:</strong> ${stats.bestScore}
                                    </div>
                                    <div>
                                        <strong>Completion:</strong> ${stats.completionRate}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                return html;
            } else {
                const stats = await getClassStatistics(kelas);
                if (!stats || stats.totalStudents === 0) {
                    return `<p style="text-align: center; padding: 20px; color: #666;">Tidak ada data untuk kelas ${kelas}</p>`;
                }
                
                return `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h4>Statistik Kelas ${kelas}</h4>
                        <div class="stats-grid" style="margin-top: 15px;">
                            <div class="stat-card">
                                <h3>${stats.totalStudents}</h3>
                                <p>Total Siswa</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.averageScore}</h3>
                                <p>Rata-rata Skor</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.bestScore}</h3>
                                <p>Skor Tertinggi</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.completionRate}%</h3>
                                <p>Completion Rate</p>
                            </div>
                        </div>
                        ${stats.bestStudent ? `
                            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px;">
                                <i class="fas fa-trophy" style="color: #FFD700;"></i>
                                <strong> Siswa Terbaik:</strong> ${stats.bestStudent} (${stats.bestScore} poin)
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        async function generateStudentReportContent() {
            const studentId = document.getElementById('reportStudent').value;
            if (!studentId) {
                return `<p style="text-align: center; padding: 20px; color: #666;">Pilih siswa terlebih dahulu</p>`;
            }
            
            const user = allUsers.find(u => u.id === studentId);
            if (!user) {
                return `<p style="text-align: center; padding: 20px; color: #666;">Siswa tidak ditemukan</p>`;
            }
            
            const progress = await getUserProgress(studentId);
            
            return `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4>Laporan Siswa: ${user.nama}</h4>
                    <div style="margin-top: 15px;">
                        <p><strong>Kelas:</strong> ${user.kelas || '-'}</p>
                        <p><strong>Role:</strong> ${user.role}</p>
                        <p><strong>Email:</strong> ${user.email || '-'}</p>
                        <p><strong>Tanggal Daftar:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('id-ID') : '-'}</p>
                    </div>
                    
                    ${progress ? `
                        <div class="stats-grid" style="margin-top: 20px;">
                            <div class="stat-card">
                                <h3>${progress.totalDays}</h3>
                                <p>Total Hari</p>
                            </div>
                            <div class="stat-card">
                                <h3>${progress.totalPoints}</h3>
                                <p>Total Poin</p>
                            </div>
                            <div class="stat-card">
                                <h3>${progress.averageScore}</h3>
                                <p>Rata-rata</p>
                            </div>
                            <div class="stat-card">
                                <h3>${progress.completionRate}%</h3>
                                <p>Completion</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5>Pencapaian Terbaik</h5>
                            <p>Skor tertinggi: <strong>${progress.bestScore} poin</strong></p>
                        </div>
                    ` : `
                        <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                            <i class="fas fa-info-circle"></i>
                            <p>Siswa ini belum mengisi tracker kebiasaan.</p>
                        </div>
                    `}
                </div>
            `;
        }
        
        async function generateHabitsReportContent() {
            // Get all habits data
            const snapshot = await db.collection('habits').get();
            if (snapshot.empty) {
                return `<p style="text-align: center; padding: 20px; color: #666;">Belum ada data kebiasaan</p>`;
            }
            
            // Calculate habits statistics
            const habitsStats = {
                bangunPagi: 0,
                sholat: 0,
                olahraga: 0,
                makan: 0,
                belajar: 0,
                bantuOrtu: 0,
                tidur: 0
            };
            
            snapshot.forEach(doc => {
                const habits = doc.data().habits || {};
                
                if (habits.bangunPagi) habitsStats.bangunPagi++;
                if (habits.subuh || habits.dzuhur || habits.ashar || habits.magrib || habits.isya) habitsStats.sholat++;
                if (habits.olahragaJenis) habitsStats.olahraga++;
                if (habits.makanPagi || habits.makanSiang || habits.makanMalam) habitsStats.makan++;
                if (habits.belajarMateri) habitsStats.belajar++;
                if (habits.bantuOrangTua) habitsStats.bantuOrtu++;
                if (habits.tidurWaktu) habitsStats.tidur++;
            });
            
            const totalEntries = snapshot.size;
            
            return `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4>Analisis 7 Kebiasaan</h4>
                    <p>Berdasarkan ${totalEntries} entri data</p>
                    
                    <div style="margin-top: 20px;">
                        ${Object.entries(habitsStats).map(([habit, count]) => {
                            const percentage = Math.round((count / totalEntries) * 100);
                            return `
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span><strong>${getHabitName(habit)}</strong></span>
                                        <span>${count} (${percentage}%)</span>
                                    </div>
                                    <div style="height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; width: ${percentage}%; background: #4CAF50;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function getHabitName(habitKey) {
            const names = {
                bangunPagi: '1. Bangun Pagi',
                sholat: '2. Rajin Beribadah',
                olahraga: '3. Olahraga',
                makan: '4. Makan Sehat',
                belajar: '5. Belajar',
                bantuOrtu: '6. Bantu Orang Tua',
                tidur: '7. Tidur Cepat'
            };
            return names[habitKey] || habitKey;
        }
        
        function cancelReport() {
            document.getElementById('reportFilters').style.display = 'none';
            document.getElementById('reportResults').style.display = 'none';
        }
        
        function printReport() {
            window.print();
        }
        
        function downloadReport() {
            alert('Fitur download PDF akan tersedia di versi mendatang.');
        }
        
        function exportReportToExcel() {
            alert('Fitur export Excel untuk laporan akan tersedia di versi mendatang.');
        }
        
        // ==============================================
        // CHART FUNCTIONS
        // ==============================================
        
        function updateUserChart(regularUsers, adminUsers) {
            const ctx = document.getElementById('userChart');
            if (!ctx) return;
            
            // Destroy existing chart if exists
            if (userChartInstance) {
                userChartInstance.destroy();
            }
            
            userChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Pengguna Biasa', 'Admin'],
                    datasets: [{
                        data: [regularUsers, adminUsers],
                        backgroundColor: ['#4CAF50', '#2196F3'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==============================================
        // SYSTEM FUNCTIONS
        // ==============================================
        
        function updateSystemInfo() {
            // Browser info
            document.getElementById('browserInfo').textContent = 
                navigator.userAgent.split(' ')[0];
            
            // Screen resolution
            document.getElementById('screenResolution').textContent = 
                `${window.screen.width} √ó ${window.screen.height}`;
            
            // Local storage
            const lsSize = JSON.stringify(localStorage).length;
            document.getElementById('localStorageStatus').textContent = 
                `${(lsSize / 1024).toFixed(2)} KB`;
            
            // Timezone
            document.getElementById('timezone').textContent = 
                Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Update time
            updateTime();
        }
        
        function updateTime() {
            const now = new Date();
            
            document.getElementById('serverTime').textContent = 
                now.toLocaleString('id-ID');
            
            document.getElementById('localTime').textContent = 
                now.toLocaleTimeString('id-ID');
            
            // Update uptime (simulated)
            const uptimeDiv = document.getElementById('uptime');
            if (window.startTime) {
                const uptime = Math.floor((now - window.startTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                uptimeDiv.textContent = `${hours}h ${minutes}m ${seconds}s`;
            } else {
                window.startTime = now;
                uptimeDiv.textContent = '0s';
            }
        }
        
        function startSystemUpdates() {
            window.startTime = new Date();
            
            // Update time every second
            setInterval(updateTime, 1000);
            
            // Update sync time every minute
            setInterval(() => {
                document.getElementById('lastSync').textContent = 
                    new Date().toLocaleTimeString('id-ID');
            }, 60000);
        }
        
        async function testDatabaseConnection() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                btn.disabled = true;
                
                // Test connection
                const testRef = await db.collection('test_connection').add({
                    test: 'connection_test',
                    timestamp: new Date().toISOString()
                });
                
                // Get collections count
                const collections = ['users', 'habits', 'classes'];
                let totalDocs = 0;
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    totalDocs += snapshot.size;
                }
                
                // Cleanup test
                await db.collection('test_connection').doc(testRef.id).delete();
                
                // Update UI
                document.getElementById('firebaseStatus').innerHTML = 
                    '<span style="color: #4CAF50;">‚úÖ Connected</span>';
                document.getElementById('collectionsCount').textContent = collections.length;
                document.getElementById('totalDocuments').textContent = totalDocs;
                
                alert('‚úÖ Database connection successful!');
                
            } catch (error) {
                document.getElementById('firebaseStatus').innerHTML = 
                    '<span style="color: #f44336;">‚ùå Disconnected</span>';
                alert('‚ùå Database connection failed: ' + error.message);
            } finally {
                event.target.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
                event.target.disabled = false;
            }
        }
        
        function clearAdminCache() {
            if (confirm('Clear semua cache admin?\n\nIni akan menghapus data sementara di browser.')) {
                // Clear only admin-related cache
                const keysToKeep = ['currentUser', 'auth_session', 'userNama', 'userRole', 'userId'];
                
                Object.keys(localStorage).forEach(key => {
                    if (!keysToKeep.includes(key) && !key.startsWith('habits_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                alert('‚úÖ Cache cleared!');
                location.reload();
            }
        }
        
        async function backupDatabase() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backing up...';
                btn.disabled = true;
                
                // Collect all data
                const backupData = {
                    timestamp: new Date().toISOString(),
                    admin: getCurrentUser().nama,
                    collections: {}
                };
                
                // Backup users
                const usersSnapshot = await db.collection('users').get();
                backupData.collections.users = usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Backup habits
                const habitsSnapshot = await db.collection('habits').get();
                backupData.collections.habits = habitsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Backup classes
                const classesSnapshot = await db.collection('classes').get();
                backupData.collections.classes = classesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Create download
                const blob = new Blob([JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const dateStr = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `backup_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Backup berhasil!\nUsers: ${usersSnapshot.size}\nHabits: ${habitsSnapshot.size}\nClasses: ${classesSnapshot.size}`);
                
            } catch (error) {
                alert('‚ùå Backup failed: ' + error.message);
            } finally {
                event.target.innerHTML = '<i class="fas fa-download"></i> Backup Database';
                event.target.disabled = false;
            }
        }
        
        function restoreDatabase() {
            alert('‚ö†Ô∏è Fitur restore akan tersedia di versi mendatang.\nGunakan Firebase Console untuk restore data.');
        }
        
        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        
        async function refreshAllData() {
            try {
                const btn = event?.target || document.querySelector('button[onclick="refreshAllData()"]');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                    btn.disabled = true;
                    
                    await loadInitialData();
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert('‚úÖ Data berhasil di-refresh!');
                } else {
                    await loadInitialData();
                }
            } catch (error) {
                alert('‚ùå Gagal refresh: ' + error.message);
            }
        }
        
        function exportAllData() {
            alert('‚ö†Ô∏è Fitur export lengkap akan tersedia di versi mendatang.\nGunakan backup database untuk sekarang.');
        }
        // ==============================================
// BULK USER UPLOAD FUNCTIONS
// ==============================================

async function addBulkUsers(usersData) {
    console.log('üì§ Adding bulk users:', usersData.length, 'users');
    
    try {
        const db = firebase.firestore();
        const batch = db.batch();
        
        let successCount = 0;
        let errorCount = 0;
        
        // Proses setiap user
        for (const user of usersData) {
            try {
                // Generate document ID dari nama (atau auto ID)
                const userDocRef = db.collection('users').doc();
                
                // Data user
                const userData = {
                    nama: user.nama || '',
                    kelas: user.kelas || '',
                    sekolah: user.sekolah || '',
                    email: user.email || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'user'
                };
                
                batch.set(userDocRef, userData);
                successCount++;
                
            } catch (error) {
                console.error('Error processing user:', user, error);
                errorCount++;
            }
        }
        
        // Commit batch
        await batch.commit();
        console.log(`‚úÖ Bulk upload complete: ${successCount} success, ${errorCount} failed`);
        
        return {
            success: true,
            message: `Berhasil upload ${successCount} user`,
            successCount: successCount,
            errorCount: errorCount
        };
        
    } catch (error) {
        console.error('‚ùå Bulk upload error:', error);
        return {
            success: false,
            message: 'Upload gagal: ' + error.message
        };
    }
}

// Fungsi untuk load classes (jika diperlukan)
async function getAllClasses() {
    try {
        const db = firebase.firestore();
        const snapshot = await db.collection('classes').get();
        const classes = [];
        snapshot.forEach(doc => {
            classes.push({ id: doc.id, ...doc.data() });
        });
        return classes;
    } catch (error) {
        console.error('Error loading classes:', error);
        return [];
    }
}
        
        // ==============================================
        // EXPOSE FUNCTIONS TO WINDOW
        // ==============================================
        
        window.searchUsers = searchUsers;
        window.resetSearch = resetSearch;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.editUser = editUser;
        window.deleteUserById = deleteUserById;
        window.makeAdmin = makeAdmin;
        window.addBulkUsers = addBulkUsers;
        window.downloadExcelTemplate = downloadExcelTemplate;
        window.uploadExcelFile = uploadExcelFile;
        window.confirmImport = confirmImport;
        window.loadProgressData = loadProgressData;
        window.resetProgressFilters = resetProgressFilters;
        window.exportProgressToExcel = exportProgressToExcel;
        window.viewUserDetail = viewUserDetail;
        window.generateDailyReport = generateDailyReport;
        window.generateWeeklyReport = generateWeeklyReport;
        window.generateMonthlyReport = generateMonthlyReport;
        window.generateClassReport = generateClassReport;
        window.generateStudentReport = generateStudentReport;
        window.generateHabitsReport = generateHabitsReport;
        window.generateReport = generateReport;
        window.cancelReport = cancelReport;
        window.printReport = printReport;
        window.downloadReport = downloadReport;
        window.exportReportToExcel = exportReportToExcel;
        window.testDatabaseConnection = testDatabaseConnection;
        window.clearAdminCache = clearAdminCache;
        window.backupDatabase = backupDatabase;
        window.restoreDatabase = restoreDatabase;
        window.refreshAllData = refreshAllData;
        window.exportAllData = exportAllData;
        
        console.log("üõ†Ô∏è Admin functions ready!");
    </script>
</body>
</html>
